<!-- Define a new standard component for the pmc -->
<link rel="import" href="libraries.html">
<script type="text/javascript">
    //Constructor
    class PMCComponent extends HTMLElement {
        constructor() {
            super();
        }

        currentValuesToString () {
            var refToDisplay = this.refvalue;
            if (this.reference === "plant") {
                refToDisplay = this.pltvalue;
            }
            return "[" + this.id + "] Current: " + this.getValue() + " Plant: " + this.getPlantValue() + " Reference: " + this.getReferenceValue() + " Initial: " + this.getInitialValue();
        }

        showValues () {
            alert(this.currentValuesToString());
        }

        compareValues (value1, value2) {
            var val1 = String(value1);
            var val2 = String(value2);
            if (this.typeValue !== undefined) {
                if ((!this.library) && (this.typevalue === "float32") || (this.typevalue === "float64")) {
                        val1 = parseFloat(value1);
                        val2 = parseFloat(value2);
                }
                else if ((!this.library) && (this.typevalue.startsWith("int") || (this.typevalue.startsWith("uint")))) {
                        val1 = parseInt(value1);
                        val2 = parseInt(value2);
                }
            }
            return (val1 === val2);
        }

        compareWithReference (value, pltValue, refValue) {
            var val1 = String(value);
            var val2 = String(value);
            //If the reference value does not match the current value, change the background
            if (this.reference === "plant") {
                val1 = pltValue;
            }
            //must be from a schedule
            else if (this.reference !== "none") {
                val1 = refValue;
            }
            return this.compareValues(val1, val2);
        }

        checkValues (component) {
            if (component === undefined) {
                component = this;
            }
            //If the current value does not match the initial value set the font color blue
            if(!this.compareValues(this.getValue(), this.getInitialValue())) {
                component.style.color = DIFF_INIT_CHANGED_COLOR;
            }
            else {
                component.style.color = STANDARD_FCOLOR;
            }

            var newBackgroundColor = STANDARD_BCOLOR;
            if (this.compareWithReference(this.getValue(), this.getPlantValue(), this.getReferenceValue())) {
                newBackgroundColor = STANDARD_BCOLOR;
            }
            else {
                newBackgroundColor = PLANT_OR_REF_CHANGED_COLOR;
            }

            var error = false;
            var fun;
            var validation;
            if (this.validations !== undefined) {
                for (var i=0; (i<this.validations.length) && (!error); i++) {
                    validation = this.validations[i];
                    fun = eval(validation.fun);
                    if (fun !== undefined) {
                        if (validation.parameters === undefined) {
                            validation.parameters = [];
                        }
                        error = !fun(this, validation.parameters);
                    }
                }
            }
            var titleString = this.currentValuesToString();
            if (error) {
                newBackgroundColor = ERROR_BCOLOR;
                titleString = "Failed @ " + fun.name + " (" + validation.parameters + ")" + " [ " + validation.description + " ] ";
            }
            component.style.backgroundColor = newBackgroundColor;
            component.title = titleString;
        }

        /**
         * virtual 
         * To be specialised by other components that want to be warned when a browser refresh has happened.
         */
        refresh () {
        }

        getNumberOfElements () {
            return this.numberOfElements;
        }

        setNumberOfElements (numberOfElementsIn) {
            this.numberOfElements = numberOfElementsIn;
        }

        getReferenceValue () {
            return this.refvalue;
        }

        setReferenceValue (referenceValueToSet) {
            if (referenceValueToSet !== undefined) {
                this.refvalue = referenceValueToSet.slice(0);
                this.checkValues();
            }
        }

        isLibrary () {
            return this.library;
        }

        setLibrary (isLibrary) {
            this.library = isLibrary;
        }

        getTypeValue () {
            return this.typevalue;
        }

        setTypeValue (typeValueToSet) {
            this.typevalue = typeValueToSet;
        }

        getPlantValue () {
            return this.pltvalue;
        }

        setPlantValue (plantValueToSet) {
            if (plantValueToSet !==  undefined) {
                this.pltvalue = plantValueToSet.slice(0);
                this.fireValueChanged("plantValue");
            }
        }

        getInitialValue () {
            return this.initvalue;
        }

        setInitialValue (initialValueToSet) {
            this.initvalue = initialValueToSet.slice(0);
            this.fireValueChanged("initialValue");
        }

        getReference () {
            return this.reference;
        }

        setReference (referenceToSet) {
            this.reference = referenceToSet;
            this.fireValueChanged("reference");
        }

        getValue () {
            return this.value;
        }

        setValue (valueToSet) {
            this.value = valueToSet;
            this.fireValueChanged("value");
            if (currentScheduleId !== undefined) {
                var valueToUpdate = {
                    id:this.id,
                    scheduleId:currentScheduleId,
                    value:valueToSet
                }
                $.ajax({
                    type: "get",
                    url: "/updateschedule",
                    data: "update=" + JSON.stringify(valueToUpdate),
                    success: function (response) {
                    }.bind(this),
                    error: function (response) {
                        console.log(response);
                        alert(response);
                    }
                });
            }
        }

        setValidations (validationsToSet) {
            this.validations = validationsToSet;
        }

        getValidations () {
            return this.validations;
        }

        domLoaded () {
        }

        getTemplate() {
        }

        valueChanged(source, typeOfChange) {
        }

        fireValueChanged(typeOfChange) {
            for(var f in this.valueChangedListeners) {
                this.valueChangedListeners[f].valueChanged(this, typeOfChange);
            }
        }

        addValueChangedListener(comp) {
            this.valueChangedListeners.push(comp);
        }

        createdCallback() {
            var template = this.getTemplate();
            if (template !== undefined) {
                // import template into
                var clone = document.importNode(template.content, true);
                var root = this.createShadowRoot();
                root.appendChild(clone);
                allPMCComponents[this.id] = this;
            }
            this.valueChangedListeners = [this];
        }

        attachedCallback () {
        }

        detachedCallback () {
        }
    }
    //The reference in use
    Object.defineProperty(PMCComponent, "reference", {
        value: "none",
        writable: true
    });


    //The type of value
    Object.defineProperty(PMCComponent, "typevalue", {
        value: "string",
        writable: true
    });

    //Initial value
    Object.defineProperty(PMCComponent, "initvalue", {
        value: "N/A",
        writable: true
    });

    //Plant value
    Object.defineProperty(PMCComponent, "pltvalue", {
        value: "N/A",
        writable: true
    });

    //Reference value
    Object.defineProperty(PMCComponent, "refvalue", {
        value: "N/A",
        writable: true
    });

    //Number of elements
    Object.defineProperty(PMCComponent, "numberOfElements", {
        value: "N/A",
        writable: true
    });

    //If true the value is a pointer to a library (e.g. a waveform name) which actually stores the values
    Object.defineProperty(PMCComponent, "library", {
        value: "N/A",
        writable: true
    });

    Object.defineProperty(PMCComponent, "validations", {
        value: "",
        writable: true
    });

</script>

