<html>
    <head>
        <link rel="import" href="libraries.html">
        <link rel="import" href="pmc-component.html">
    </head>
    <body>
        <template id="ttarray">
            <div id="darray">
                <table border="0">
                    <tr>
                        <td>
                            <table border="1" id="tarray">
                                <tr></tr>
                            </table>
                        </td>
                        <td>
                            <button type="button" id="addButton">+</button>
                            <button type="button" id="removeButton">-</button>
                        </td>
                    </tr>
                </table>
            </div>
        </template>
        <script>
            function PMCArrayEditor() {
                HTMLElement.call(this);
            }
            
            (function () {
                var importDoc = document.currentScript.ownerDocument; // importee

                var PMCArrayEditorProto = Object.create(HTMLElement.prototype);
                PMCArrayEditorProto.constructor = PMCArrayEditor;
            
                extendMixin(PMCArrayEditorProto, PMCComponent.prototype);

                PMCArrayEditorProto.checkValues = function() {
                    //If the current value does not match the initial value set the font color blue
                    var tbl = this.shadowRoot.querySelector("#tarray");
                    var row = tbl.rows[0];
                    var initialValue = this.getInitialValue();
                    var refValue = this.getReferenceValue();
                    var plantValue = this.getPlantValue();
                   
                    for (var i=0; (i<this.numberOfElements); i++) { 
                        var cell = row.cells[i];
                        var cellValue = cell.innerHTML;
                        this.value[i] = cellValue;
                        var cellInitValue = "";
                        if (initialValue !== undefined) {
                            cellInitValue = initialValue[i];
                        }
                        if(!this.compareValues(cellValue, cellInitValue)) {
                            cell.style.color = DIFF_INIT_CHANGED_COLOR;
                        }
                        else {
                            cell.style.color = STANDARD_FCOLOR;
                        }
                        var newBackgroundColor = STANDARD_BCOLOR;
                       
                        var cellRefValue = "";
                        if (refValue !== undefined) { 
                            cellRefValue = refValue[i];
                        }
                        var cellPlantValue;
                        if (plantValue !== undefined) { 
                            cellPlantValue = plantValue[i];
                        }

                        if (this.compareWithReference(cellValue, cellPlantValue, cellRefValue)) {
                            newBackgroundColor = STANDARD_BCOLOR;
                        }
                        else {
                            newBackgroundColor = PLANT_OR_REF_CHANGED_COLOR;
                        }
                        cell.style.backgroundColor = newBackgroundColor;
                    }
                    var error = false; 
                    var validations = this.getValidations();
                    var validation;
                    if (this.validations !== undefined) {
                        for (var i=0; (i<validations.length) && (!error); i++) {
                            validation = validations[i];
                            fun = eval(validation.fun);
                            if (fun !== undefined) {
                                if (validation.parameters === undefined) {
                                    validation.parameters = [];
                                }
                                var parameters = [this];
                                for (p in validation.parameters) {
                                    parameters.push(validation.parameters[p]);
                                }
                                error = !fun(...parameters);
                            }
                        }
                    }
                    if(error) {
                        newBackgroundColor = ERROR_BCOLOR;
                        for (var i=0; (i<this.numberOfElements); i++) { 
                            var cell = row.cells[i];
                            cell.style.backgroundColor = ERROR_BCOLOR;
                        }

                        this.title = "Failed @ " + fun.name + " [ " + validation.description + " ] ";
                    }
                    else {
                        this.title = this.currentValuesToString();
                    }
                }

                PMCArrayEditorProto.setValue = function(elementsToSet) {
                    this.setNumberOfElements(elementsToSet.length);
                    var tbl = this.shadowRoot.querySelector("#tarray");
                    tbl.deleteRow(0);
                    var row = tbl.insertRow(0);
                    for (var i=0; i<elementsToSet.length; i++) {
                        var col = row.insertCell(i);
                        col.innerHTML = elementsToSet[i];
                        col.setAttribute("contenteditable", "true");
                        col.style.width = "20px";
                        col.style.textAlign = "right";
                        col.addEventListener("input", function (e) {
                            this.checkValues();
                        }.bind(this));
                    }
                    //Make a shallow copy!
                    this.value = elementsToSet.slice(0);
                }

                // Use Shadow DOM and a template.
                PMCArrayEditorProto.createdCallback = function() {
                    // Get template 
                    var template = importDoc.querySelector("#ttarray");

                    // import template into
                    var clone = document.importNode(template.content, true);
                    var root = this.createShadowRoot();
 
                    root.appendChild(clone);
                    allPMCComponents[this.id] = this;
                    var addButton = this.shadowRoot.querySelector("#addButton");
                    addButton.onclick = function() {
                        var tbl = this.shadowRoot.querySelector("#tarray");
                        var row = tbl.rows[0];
                        var col = row.insertCell();
                        this.numberOfElements++;
                        col.setAttribute("contenteditable", "true");
                        col.style.width = "20px";
                        col.style.textAlign = "right";
                        col.addEventListener("input", function (e) {
                            this.checkValues();
                        }.bind(this));
                        this.checkValues();
                    }.bind(this);

                    var removeButton = this.shadowRoot.querySelector("#removeButton");
                    removeButton.onclick = function() {
                        var tbl = this.shadowRoot.querySelector("#tarray");
                        var row = tbl.rows[0];
                        if (row.cells.length > 0) {
                            row.deleteCell(row.cells.length - 1);
                        }
                        this.numberOfElements--;
                        this.value = this.value.slice(0, this.numberOfElements);
                        this.checkValues();
                    }.bind(this);

                };

                PMCArrayEditorProto.attachedCallback = function() {
                };

                document.registerElement("pmc-array-editor", {
                    prototype: PMCArrayEditorProto
                });
            })();
        </script>

    </body>
</html>
