<html>
    <head>
        <link rel="import" href="libraries.html">
        <link rel="import" href="pmc-array-editor.html">
    </head>
    <body>
        <template id="tarrayselector">
            <dialog id="darrayselector">
                <h3>
                    Array selector v0.0
                </h3>
                <select id="tarrayselect" name="tarrayselect"></select>
                <br/>
                <br/>
                <button id="tarrayselectorOK">OK</button>
                <button id="tarrayselectorCancel">Cancel</button>
                <button id="tarrayselectorEdit">Edit</button>
            </dialog>
        </template>
        <script>
            (function () {
                var importDoc = document.currentScript.ownerDocument; // importee

                var PMCArraySelectorProto = Object.create(HTMLElement.prototype);

                //The owner of this selector dialog
                Object.defineProperty(PMCArraySelectorProto, "ownerarray", {
                    value: "",
                    writable: true
                });

                //Array which has been selected
                Object.defineProperty(PMCArraySelectorProto, "selarray", {
                    value: "",
                    writable: true
                });
            
                PMCArraySelectorProto.showSelector = function(avArrays) {
                    var diag = this.shadowRoot.querySelector("#darrayselector");
                    var selector = this.shadowRoot.querySelector("#tarrayselect");
                    selector.innerHTML = "";
                    $.each(avArrays, function(i, avArray) {
                        var option = document.createElement( 'option' );
                        option.value = option.text = avArray;
                        selector.add(option);
                    });
                    diag.showModal();
                }

                // Use Shadow DOM and a template. Use the attachedCallback as @ createdCallback this.ownerarray will not exist and I need this id (at least in this prototype phase)
                PMCArraySelectorProto.attachedCallback = function() {
                    // Get template 
                    var template = importDoc.querySelector("#tarrayselector");

                    // import template into
                    var clone = document.importNode(template.content, true);
                    var root = this.createShadowRoot();
 
                    root.appendChild(clone);

                    var diag = this.shadowRoot.querySelector("#darrayselector");
                    var selector = this.shadowRoot.querySelector("#tarrayselect");
                    var okButton = this.shadowRoot.querySelector("#tarrayselectorOK");
                    var cancelButton = this.shadowRoot.querySelector("#tarrayselectorCancel");
                    var editButton = this.shadowRoot.querySelector("#tarrayselectorEdit");

                    okButton.onclick = function() {
                        this.selarray = selector.options[selector.selectedIndex].text;
                        this.ownerarray.changeArray(this.selarray);
                        diag.close();
                    }.bind(this); //bind is needed to make sure that the "this" is still valid in the context of the callback

                    cancelButton.onclick = function() {
                        this.selarray = "";
                        diag.close();
                    }.bind(this); //bind is needed to make sure that the "this" is still valid in the context of the callback

                    //Attach an editor
                    var editor = document.createElement("pmc-array-editor");
                    var editorId = this.ownerarray.id + "-editor";
                    console.log(editorId);
                    console.log(this.id);
                    editor.setAttribute("id", editorId);
                    document.body.appendChild(editor);
                    editButton.onclick = function() {
                        console.log(this.id);
                        var editor = document.getElementById(this.ownerarray.id + "-editor");
                        console.log(this.id + "-editor");
                        console.log(editor);
                        $.ajax({
                            type: "get",
                            url: "/getarray",
                            data: {
                                variable : this.ownerarray.id, 
                                arrayName : selector.options[selector.selectedIndex].text  
                            },
                            success: function (response) {
                                values = $.parseJSON(response);
                                editor.numberOfElements = values.length;
                                diag.close();
                                editor.showEditor(values);
                                console.log(values);
                            },
                            error: function (response) {
                                console.log(response);
                                alert(response);
                            }
                        });

                    }.bind(this);
                };

                document.registerElement("pmc-array-selector", {
                    prototype: PMCArraySelectorProto
                });
            })();
        </script>

    </body>
</html>
