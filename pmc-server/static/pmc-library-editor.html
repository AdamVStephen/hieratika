<html>
    <head>
        <link rel="import" href="libraries.html">
    </head>
    <body>
        <template id="tselector">
            <dialog id="dselector">
                <table style="border-style: dotted;border-width: 3px;width: 100%">
                    <tr>
                        <td><div id="diveditor"></div></td>
                    </tr>
                </table>
                </br>
                <table style="border-style:solid;border-width:1px;width: 100%">
                    <tr>
                        <td><select id="tselect" name="tselect"></select></td>
                        <td><button id="saveAsButton">Save as...</button><input type="text" id="saveAsLibraryName"></input></td>
                    </tr>
                    <tr>
                        <td colspan="3"><textarea rows="2" cols="60" id="descriptionTextArea" title="Description"></textarea></td>
                    </tr>
                </table>
                </br>
                <table style="border-style:solid;border-width:1px;width: 100%">
                    <tr>
                        <td><button id="tselectorOK">OK</button><button id="tselectorCancel">Cancel</button></td>
                    </tr>
                </table>
            </dialog>
        </template>
        <script>
            (function () {
                var importDoc = document.currentScript.ownerDocument; // importee

                class PMCLibraryEditor extends HTMLElement {
                    constructor() {
                        super();
                    }

                    showSelector (availableLibraries, currentLibraryName) {
                        var diag = this.shadowRoot.querySelector("#dselector");
                        var selector = this.shadowRoot.querySelector("#tselect");
                        selector.innerHTML = "";
                        $.each(availableLibraries, function(i, library) {
                            var option = document.createElement( 'option' );
                            option.id = library.id;
                            option.value = library.name;
                            option.text = library.name;
                            selector.add(option);
                        });
                        selector.value = currentLibraryName;
                        this.editLibrary();
                        diag.showModal();
                    }

                    getLibrary(libraryName, successFn) {
                        var user = JSON.parse(localStorage.user);
                        if (libraryName.length > 0) {
                            $.ajax({
                                type: "post",
                                url: "/getlibrary",
                                data: {
                                    token: currentToken,
                                    variableId: this.owner.id, 
                                    userId: user.id, 
                                    libraryName: libraryName 
                                },
                                success: successFn.bind(this),
                                error: function (response) {
                                    console.log(response);
                                    alert(response);
                                }
                            });
                        }
                    }

                    editLibrary (valueOnly = false) {
                        if (!valueOnly) {
                            var ownerReference = this.owner.getReference();
                            var ownerReferenceValue = this.owner.getReferenceValue();
                            var ownerInitialValue = this.owner.getInitialValue();
                            var ownerPlantValue = this.owner.getPlantValue();
                            if (ownerReference !== "none") {
                                if (ownerReferenceValue !== undefined) {
                                    this.getLibrary(ownerReferenceValue, function (response) {
                                        var library = $.parseJSON(response);
                                        var libraryVariables = library["variables"];
                                        for (var v in libraryVariables) {
                                            var libraryVariable = libraryVariables[v];
                                            var comps = this.editorComponents[libraryVariable.variableId];
                                            for (var c in comps) {
                                                comps[c].setReferenceValue(libraryVariable.value);
                                            } 
                                        }
                                    });
                                }
                            }
                            if (ownerInitialValue !== undefined) {
                                this.getLibrary(ownerInitialValue, function (response) {
                                    var library = $.parseJSON(response);
                                    var libraryVariables = library["variables"];
                                    for (var v in libraryVariables) {
                                        var libraryVariable = libraryVariables[v];
                                        var comps = this.editorComponents[libraryVariable.variableId];
                                        for (var c in comps) {
                                            comps[c].setInitialValue(libraryVariable.value);
                                        } 
                                    }
                                });
                            }
                            if (ownerPlantValue !== undefined) {
                                this.getLibrary(ownerPlantValue, function (response) {
                                    var library = $.parseJSON(response);
                                    var libraryVariables = library["variables"];
                                    for (var v in libraryVariables) {
                                        var libraryVariable = libraryVariables[v];
                                        var comps = this.editorComponents[libraryVariable.variableId];
                                        for (var c in comps) {
                                            comps[c].setPlantValue(libraryVariable.value);
                                        } 
                                    }
                                });
                            }
                        } 
                        if (this.selector.selectedIndex >= 0) {
                            var libraryName = this.selector.options[this.selector.selectedIndex].text;
                            this.getLibrary(libraryName, function (response) {
                                var library = $.parseJSON(response);
                                var libraryVariables = library["variables"];
                                for (var v in libraryVariables) {
                                    var libraryVariable = libraryVariables[v];
                                    var comps = this.editorComponents[libraryVariable.variableId];
                                    for (var c in comps) {
                                        comps[c].setValue(libraryVariable.value);
                                    } 
                                }
                                this.saveAsLibraryName.value = libraryName;
                                this.descriptionTextArea.value = (library["description"]);
                            });
                        } 
                    }

                    createdCallback() {
                        // Get template 
                        var template = importDoc.querySelector("#tselector");

                        // import template into
                        var clone = document.importNode(template.content, true);
                        var root = this.createShadowRoot();
     
                        root.appendChild(clone);

                        var diag = this.shadowRoot.querySelector("#dselector");
                        this.selector = this.shadowRoot.querySelector("#tselect");
                        this.okButton = this.shadowRoot.querySelector("#tselectorOK");
                        var cancelButton = this.shadowRoot.querySelector("#tselectorCancel");
                        this.saveAsButton = this.shadowRoot.querySelector("#saveAsButton");
                        this.saveAsLibraryName = this.shadowRoot.querySelector("#saveAsLibraryName");
                        this.descriptionTextArea = this.shadowRoot.querySelector("#descriptionTextArea");

                        this.okButton.onclick = function() {
                            this.selected = this.selector.options[this.selector.selectedIndex].text;
                            this.owner.libraryChanged(this.selected);
                            diag.close();
                            document.body.removeChild(this);
                        }.bind(this); //bind is needed to make sure that the "this" is still valid in the context of the callback

                        cancelButton.onclick = function() {
                            this.selected = "";
                            diag.close();
                            document.body.removeChild(this);
                        }.bind(this); //bind is needed to make sure that the "this" is still valid in the context of the callback

                        this.selector.onchange = function() {
                            this.editLibrary(true);
                        }.bind(this);

                        this.saveAsButton.onclick = function() {
                            var saveAsName = this.saveAsLibraryName.value;
                            var description = this.descriptionTextArea.value;
                            var user = JSON.parse(localStorage.user);
                            var variablesValues = [];
                            for (var key in this.editorComponents) {
                                var comps = this.editorComponents[key];
                                //The same id might be used in different components...
                                for (var c in comps) {
                                    variablesValues.push({
                                        variableId: comps[c].id,
                                        value: JSON.stringify(comps[c].getValue())
                                    });
                                }
                            }
                            if (saveAsName.length === 0) {
                                alert("Please introduce a library name");
                            }
                            else {
                                $.ajax({
                                    type: "post",
                                    url: "/savelibrary",
                                    data: {
                                        token: currentToken,
                                        userId: user.id, 
                                        variableId : this.owner.id, 
                                        libraryName : saveAsName,
                                        libraryDescription: description,
                                        variables: JSON.stringify(variablesValues)
                                    },
                                    success: function (response) {
                                        var library = $.parseJSON(response);
                                        if (library.id !== undefined) {
                                            var option = document.createElement( 'option' );
                                            option.id = library.id;
                                            option.value = saveAsName;
                                            option.text = saveAsName;
                                            this.selector.add(option);
                                            this.selector.value = saveAsName;
                                            this.owner.addAvailableLibrary({id:library.id, name:saveAsName});
                                            alert("Library updated successfully!");
                                        }
                                    }.bind(this),
                                    error: function (response) {
                                        console.log(response);
                                        alert(response);
                                    }
                                });
                            }
                        }.bind(this);
                        
                        this.divEditor = this.shadowRoot.querySelector("#diveditor");
                        this.editorComponents = {};
                    }

                    setOwnerComponent(owner) {
                        this.owner = owner;
                    }
    
                    setLibraryVariables(editor, libraryVariables) {
                        var editorUrl = editor + "?" + new Date().getTime(); //new Date... to force reloading with no caching
                        $.ajax({
                            type: "get",
                            url: editorUrl, 
                            success: function (response) {
                                var keys = Object.keys(libraryVariables);
                                for(var i in keys) {
                                    var reg = new RegExp("{" + keys[i] + "}", "g");
                                    console.log(reg);
                                    response = response.replace(reg, libraryVariables[keys[i]]);
                                }
                                this.divEditor.innerHTML = response;
                                console.log(this.divEditor.innerHTML);
                                var allDivTags = this.divEditor.getElementsByTagName("*");
                                for (var i=0; i<allDivTags.length; i++) {
                                    var comp = allDivTags[i];
                                    if (comp.isPMCComponent !== undefined) {
                                        if(this.editorComponents[comp.id] === undefined) {
                                            this.editorComponents[comp.id] = [comp];
                                        }
                                        else {
                                            this.editorComponents[comp.id].push(this);
                                        }
                                    }
                                }

                            }.bind(this),
                            error: function (response) {
                                console.log(response);
                                alert(response);
                            }
                        });


                        //this.editor = editor;
                        /*var divHTML = "";
                        for(var i in libraryVariables) {
                            divHTML += "<div>";
                            var varName = libraryVariables[i].variable;
                            var editorTag = libraryVariables[i].editor;
                            divHTML += varName + ": <" + editorTag + " id=\"" + varName + "\"></" + editorTag + ">\n";
                            divHTML += "</div>";
                        }
                        this.divEditor.innerHTML = divHTML;
                        var allDivTags = this.divEditor.getElementsByTagName("*");
                        for (var i=0; i<allDivTags.length; i++) {
                            var comp = allDivTags[i];
                            if (comp.id !== undefined) {
                                if(this.editorComponents[comp.id] === undefined) {
                                    this.editorComponents[comp.id] = [comp];
                                }
                                else {
                                    this.editorComponents[comp.id].push(this);
                                }
                            }
                        }*/
                    }

                    getEditor() {
                        return this.editor;
                    }

                    setReadOnly (isReadOnly) {
                        this.okButton.disabled = isReadOnly;
                    }

                    setUserAllowedToWrite (isUserAllowedToWrite) {
                        this.okButton.disabled = !isUserAllowedToWrite;
                    }
                }
                document.registerElement("pmc-library-editor", {
                    prototype: PMCLibraryEditor.prototype
                });
            })();
        </script>
    </body>
</html>
