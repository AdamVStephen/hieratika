<html>
    <head>
        <link rel="import" href="libraries.html">
    </head>
    <body>
        <template id="tselector">
            <dialog id="dselector">
                <table style="border-style: dotted;border-width: 3px;width: 100%">
                    <tr>
                        <td><div id="diveditor"></div></td>
                    </tr>
                </table>
                </br>
                <table style="border-style:solid;border-width:1px;width: 100%">
                    <tr>
                        <td><select id="tselect" name="tselect"></select></td>
                        <td><button id="saveButton">Save</button></td>
                        <td><button id="saveAsButton">Save as...</button><input type="text" id="saveAsLibraryName"></input></td>
                    </tr>
                    <tr>
                        <td colspan="3"><textarea rows="2" cols="60" id="descriptionTextArea" title="Description"></textarea></td>
                    </tr>
                </table>
                </br>
                <table style="border-style:solid;border-width:1px;width: 100%">
                    <tr>
                        <td><button id="tselectorOK">OK</button><button id="tselectorCancel">Cancel</button></td>
                    </tr>
                </table>
            </dialog>
        </template>
        <script>
            (function () {
                var importDoc = document.currentScript.ownerDocument; // importee

                class PMCLibraryEditor extends HTMLElement {
                    constructor() {
                        super();
                    }

                    showSelector (availableLibraries, currentLibraryName) {
                        var diag = this.shadowRoot.querySelector("#dselector");
                        var selector = this.shadowRoot.querySelector("#tselect");
                        selector.innerHTML = "";
                        $.each(availableLibraries, function(i, library) {
                            var option = document.createElement( 'option' );
                            option.id = library.id;
                            option.value = library.name;
                            option.text = library.name;
                            selector.add(option);
                        });
                        selector.value = currentLibraryName;
                        this.editLibrary();
                        diag.showModal();
                    }


                    editLibrary () {
                        var selector = this.shadowRoot.querySelector("#tselect");
                        var user = JSON.parse(localStorage.user);
                        /*this.editor.setTypeValue(this.owner.getTypeValue());
                        this.editor.setReference(this.owner.getReference());*/
                        if (this.owner.getReference() !== "none") {
                            var referenceValue = this.owner.getReferenceValue();
                            if (referenceValue !== undefined) {
                                $.ajax({
                                    type: "post",
                                    url: "/getlibrary",
                                    data: {
                                        token: currentToken,
                                        variableId: this.owner.id, 
                                        userId: user.id, 
                                        libraryName: this.owner.getReferenceValue()
                                    },
                                    success: function (response) {
                                        var libraryVariables = $.parseJSON(response);
                                        for (var v in libraryVariables) {
                                            var libraryVariable = libraryVariables[v];
                                            var comps = this.editorComponents[libraryVariable.variableId];
                                            for (var c in comps) {
                                                comps[c].setReferenceValue(libraryVariable.value);
                                            } 
                                        }
                                    }.bind(this),
                                    error: function (response) {
                                        console.log(response);
                                        alert(response);
                                    }
                                });
                            }
                        }
/*
                        if (this.owner.getInitialValue() !== undefined) {
                            $.ajax({
                                type: "post",
                                url: "/getlibrary",
                                data: {
                                    token: currentToken,
                                    variable : this.owner.id, 
                                    libraryName : this.owner.getInitialValue()  
                                },
                                success: function (response) {
                                    var libInfo = $.parseJSON(response);
                                    this.editor.setInitialValue(libInfo["value"][0]);
                                    this.editor.refresh();
                                }.bind(this),
                                error: function (response) {
                                    console.log(response);
                                    alert(response);
                                }
                            });
                        }

                        if (this.owner.getPlantValue() !== undefined) {
                            $.ajax({
                                type: "post",
                                url: "/getlibrary",
                                data: {
                                    token: currentToken,
                                    variable : this.owner.id, 
                                    libraryName : this.owner.getPlantValue()  
                                },
                                success: function (response) {
                                    var libInfo = $.parseJSON(response);
                                    this.editor.setPlantValue(libInfo["value"][0]);
                                    this.editor.refresh();
                                }.bind(this),
                                error: function (response) {
                                    console.log(response);
                                    alert(response);
                                }
                            });
                        }

                        $.ajax({
                            type: "post",
                            url: "/getlibrary",
                            data: {
                                token: currentToken,
                                variable : this.owner.id, 
                                libraryName : selector.options[selector.selectedIndex].text
                            },
                            success: function (response) {
                                var libInfo = $.parseJSON(response);
                                this.editor.setValue(libInfo["value"][0]);
                                this.descriptionTextArea.value = (libInfo["description"]);
                                this.editor.refresh();
                            }.bind(this),
                            error: function (response) {
                                console.log(response);
                                alert(response);
                            }
                        });*/
                    }

                    createdCallback() {
                        // Get template 
                        var template = importDoc.querySelector("#tselector");

                        // import template into
                        var clone = document.importNode(template.content, true);
                        var root = this.createShadowRoot();
     
                        root.appendChild(clone);

                        var diag = this.shadowRoot.querySelector("#dselector");
                        var selector = this.shadowRoot.querySelector("#tselect");
                        this.okButton = this.shadowRoot.querySelector("#tselectorOK");
                        var cancelButton = this.shadowRoot.querySelector("#tselectorCancel");
                        this.saveButton = this.shadowRoot.querySelector("#saveButton");
                        this.saveAsButton = this.shadowRoot.querySelector("#saveAsButton");
                        this.saveAsLibraryName = this.shadowRoot.querySelector("#saveAsLibraryName");
                        this.descriptionTextArea = this.shadowRoot.querySelector("#descriptionTextArea");

                        this.okButton.onclick = function() {
                            this.selected = selector.options[selector.selectedIndex].text;
                            this.owner.libraryChanged(this.selected);
                            diag.close();
                            document.body.removeChild(this);
                        }.bind(this); //bind is needed to make sure that the "this" is still valid in the context of the callback

                        cancelButton.onclick = function() {
                            this.selected = "";
                            diag.close();
                            document.body.removeChild(this);
                        }.bind(this); //bind is needed to make sure that the "this" is still valid in the context of the callback

                        selector.onchange = function() {
                            this.editLibrary();
                        }.bind(this);

                        this.saveButton.onclick = function() {
                            var saveAsName = selector.options[selector.selectedIndex].text;
                            var description = this.descriptionTextArea.value;
                            var user = JSON.parse(localStorage.user);
                            var variablesValues = [];
                            for (var key in this.editorComponents) {
                                var comps = this.editorComponents[key];
                                //The same id might be used in different components...
                                for (var c in comps) {
                                    variablesValues.push({
                                        variableId: comps[c].id,
                                        value: JSON.stringify(comps[c].getValue())
                                    });
                                }
                            }
                            if (saveAsName.length === 0) {
                                alert("Please introduce a library name");
                            }
                            else {
                                $.ajax({
                                    type: "post",
                                    url: "/savelibrary",
                                    data: {
                                        token: currentToken,
                                        userId: user.id, 
                                        variableId : this.owner.id, 
                                        libraryName : saveAsName,
                                        libraryDescription: description,
                                        variables: JSON.stringify(variablesValues)
                                    },
                                    success: function (response) {
                                        if (response == "ok") {
                                            alert("Library updated successfully!");
                                        }
                                    }.bind(this),
                                    error: function (response) {
                                        console.log(response);
                                        alert(response);
                                    }
                                });
                            }
                        }.bind(this);


                        this.saveAsButton.onclick = function() {
                            var saveAsName = this.saveAsLibraryName.value;
                            var description = this.descriptionTextArea.value;
                            var user = JSON.parse(localStorage.user);
                            var variablesValues = [];
                            for (var key in this.editorComponents) {
                                var comps = this.editorComponents[key];
                                //The same id might be used in different components...
                                for (var c in comps) {
                                    variablesValues.push({
                                        variableId: comps[c].id,
                                        value: JSON.stringify(comps[c].getValue())
                                    });
                                }
                            }
                            if (saveAsName.length === 0) {
                                alert("Please introduce a library name");
                            }
                            else {
                                $.ajax({
                                    type: "post",
                                    url: "/savelibrary",
                                    data: {
                                        token: currentToken,
                                        userId: user.id, 
                                        variableId : this.owner.id, 
                                        libraryName : saveAsName,
                                        libraryDescription: description,
                                        variables: JSON.stringify(variablesValues)
                                    },
                                    success: function (response) {
                                        if (response == "ok") {
                                            alert("Library updated successfully!");
                                        }
                                    }.bind(this),
                                    error: function (response) {
                                        console.log(response);
                                        alert(response);
                                    }
                                });
                            }
                        }.bind(this);
                        
                        this.divEditor = this.shadowRoot.querySelector("#diveditor");
                        this.editorComponents = {};
                    }

                    // Use Shadow DOM and a template. Use the attachedCallback as @ createdCallback this.owner will not exist and I need this id (at least in this prototype phase)
                    /*attachedCallback() {
                        if(!this.divEditor.firstChild) {
                            this.divEditor.appendChild(this.editor);
                        }
                    }*/

                    setOwnerComponent(owner) {
                        this.owner = owner;
                    }
    
                    setLibraryVariables(libraryVariables) {
                        //this.editor = editor;
                        var divHTML = "";
                        for(var i in libraryVariables) {
                            var varName = libraryVariables[i].variable;
                            var editorTag = libraryVariables[i].editor;
                            divHTML += "<" + editorTag + " id=\"" + varName + "\"></" + editorTag + ">\n";
                        }
                        this.divEditor.innerHTML = divHTML;
                        var allDivTags = this.divEditor.getElementsByTagName("*");
                        for (var i=0; i<allDivTags.length; i++) {
                            var comp = allDivTags[i];
                            if(this.editorComponents[comp.id] === undefined) {
                                this.editorComponents[comp.id] = [comp];
                            }
                            else {
                                this.editorComponents[comp.id].push(this);
                            }
                        }
                    }

                    getEditor() {
                        return this.editor;
                    }

                    setReadOnly (isReadOnly) {
                        this.okButton.disabled = isReadOnly;
                    }
                }
                document.registerElement("pmc-library-editor", {
                    prototype: PMCLibraryEditor.prototype
                });
            })();
        </script>
    </body>
</html>
