<html>
    <head>
        <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>-->
        <link rel="import" href="libraries.html">
        <link rel="import" href="pmc-input.html">
        <link rel="import" href="pmc-array.html">
<!--        <link rel="import" href="pmc-array.html">
        <link rel="import" href="pmc-array-editor.html">-->

        <!-- Handle SSE events from the server-->
        <script>
            var eventOutputContainer = document.getElementById("event");
            var evtSrc = new EventSource("/stream");
            //Changed values are received in json format
            evtSrc.onmessage = function(e) {
                var jsonPVs = $.parseJSON(e.data);
                var pvs = jsonPVs["pv"];
                var i;
                for (i in pvs) {
                    var pv = pvs[i];
                    var targetElement = document.getElementById(pv.name);
                    console.log(targetElement);
                    if (targetElement !== null) {
                        targetElement.pltvalue = pv.value;
                        targetElement.setAttribute("pltvalue", pv.value);
                    }
                }
            };
        </script>

        <script>
            //Submit new values to update the plant 
            $(function () {
                $("#updatePlantForm").on("submit", function (e) {
                    e.preventDefault();
                    $.ajax({
                        type: "get",
                        url: "/submit",
                        data: $(this).serialize(),
                        success: function (response) {
                            if (response == "done") {
                                alert("Values updated successfully!");
                                var allTextInputs = $("input:text");
                                    allTextInputs.each(function (i, textInput) {
                                        textInput.initvalue = textInput.value;
                                        textInput.setAttribute("initvalue", textInput.value);
                                    });
                                } 
                            else {
                                alert("Form submission failed!");
                                }
                            },
                            error: function (response) {
                                console.log(response);
                                alert(response);
                            }
                    });
                });
            });

            //Set parameters as reference
            $(function () {
                $("#setReferenceForm").on("submit", function (e) {
                    e.preventDefault();
                    //Check if the refence to set is none
                    var currentReference = document.getElementById("refselect").value;
                    if (currentReference === "none") {
                        //Reset all the values to N/A
                        //var allTextInputs = $("input:text");
                        var allPMCComps = $("[is^='pmc']");
                        allPMCComps.each(function (i, pmcComp) {
                            pmcComp.schvalue = "N/A";
                            pmcComp.currentReference = currentReference;
                            pmcComp.checkValues();
                        });
                    }
                    else if (currentReference === "plant") {
                        //Reset all the values to N/A
                        var allPMCComps = $("[is^='pmc']");
                        allPMCComps.each(function (i, pmcComp) {
                            pmcComp.schvalue = pmcComp.pltvalue;
                            pmcComp.currentReference = currentReference;
                            pmcComp.checkValues();
                        });
                    }
                    else {
                        var getParams = $(this).serialize();
                        //Replace the refselect with schselect to avoid collision of the two drop box
                        getParams = getParams.replace("refselect", "schselect");
                        $.ajax({
                            type: "get",
                            url: "/getschedule",
                            data: getParams,
                            success: function (response) {
                                variables = $.parseJSON(response);
                                $.each(variables, function(i, variable) {
                                    var targetElement = document.getElementById(variable.name);
                                    if (targetElement != null) {
                                        targetElement.schvalue = variable.value;
                                        targetElement.currentReference = currentReference;
                                        targetElement.setAttribute("schvalue", variable.value);
                                        targetElement.checkValues();
                                    }
                                });
                            },
                            error: function (response) {
                                console.log(response);
                                alert(response);
                            }
                        });
                    }
                });
            });

            //Load parameters from a schedule
            $(function () {
                $("#loadScheduleForm").on("submit", function (e) {
                    e.preventDefault();
                    $.ajax({
                        type: "get",
                        url: "/getschedule",
                        data: $(this).serialize(),
                        success: function (response) {
                            variables = $.parseJSON(response);
                            $.each(variables, function(i, variable) {
                                var targetElement = document.getElementById(variable.name);
                                if (targetElement != null) {
                                    targetElement.innerHTML = variable.value;
                                    targetElement.value = variable.value;
                                    targetElement.initvalue = variable.value;
                                    targetElement.setAttribute("value", variable.value);
                                    targetElement.setAttribute("initvalue", variable.value);
                                }
                            });
                        },
                        error: function (response) {
                            console.log(response);
                            alert(response);
                        }
                    });
                });
            });

            //Get all the available arrays
        </script>

        <script>
            $(document).ready(function() {
                //Load available schedule names. 
                $.ajax({
                    type: "get",
                    url: "/getschedules",
                    success: function (response) {
                        var scheduleNames = $.parseJSON(response);
                        console.log(scheduleNames);
                        $.each(scheduleNames, function(i, scheduleName) {
                            $("#schselect").append($("<option>", {
                                value: scheduleName,
                                text: scheduleName
                            }));
                        });
                        $.each(scheduleNames, function(i, scheduleName) {
                            $("#refselect").append($("<option>", {
                                value: scheduleName,
                                text: scheduleName
                            }));
                        });
                    },
                    error: function (response) {
                        console.log(response);
                        alert(response);
                    }
                });

                //Load all the types
                $.ajax({
                    type: "get",
                    url: "/getplantinfo",
                    success: function (response) {
                        var pvInfosJson = $.parseJSON(response);
                        var pvInfos = pvInfosJson["pv"];
                        $.each(pvInfos, function(i, pvInfo) {
                            var targetElement = document.getElementById(pvInfo.name);
                            if (targetElement != null) {
                                //if (pvNElements == 1) {
                                    targetElement.typevalue = pvInfo.type;
                                    targetElement.setAttribute("typevalue", pvInfo.type);
                                //}
                            }
                        });
                    },
                    error: function (response) {
                        console.log(response);
                        alert(response);
                    }
                });

                //Load all the arrays
                $.ajax({
                    type: "get",
                    url: "/getarrays",
                    success: function (response) {
                        var arraysJson = $.parseJSON(response);
                        var allArrays = arraysJson["arrays"];
                        $.each(allArrays, function(i, arrayJson) {
                            var targetElement = document.getElementById(arrayJson.variable);
                            if (targetElement != null) {
                                targetElement.avarrays = arrayJson.names;
//                                    targetElement.typevalue = pvInfo.type;
//                                    targetElement.setAttribute("typevalue", pvInfo.type);
                            }
                        });
                    },
                    error: function (response) {
                        console.log(response);
                        alert(response);
                    }
                });


            });

            function loadFromPlant() {
                var allPMCComps = $("[is^='pmc']");
                allPMCComps.each(function (i, pmcComp) {
                    pmcComp.innerHTML = pmcComp.pltvalue;
                    pmcComp.value = pmcComp.pltvalue;
                    pmcComp.checkValues();
                });
            }
        </script>
    </head>
    <body>
        <h1>PMC Example 1</h1>
        <div id="event"></div>
        <form id="updatePlantForm">
            <label for="PMC::TEST::VAR1">PMC::TEST::VAR1</label>
            <input is="pmc-input" type="text" id="PMC::TEST::VAR1" name="PMC::TEST::VAR1"></input></br>
            <label for="PMC::TEST::VAR2">PMC::TEST::VAR2</label>
            <input is="pmc-input" type="text" id="PMC::TEST::VAR2" name="PMC::TEST::VAR2"></input></br>
            <label for="PMC::TEST::VAR3">PMC::TEST::VAR3</label>
            <button is="pmc-array" type="button" id="PMC::TEST::VAR3" name="PMC::TEST::VAR3"></button></br>
            <label for="PMC::TEST::VAR4">PMC::TEST::VAR4</label>
            <button is="pmc-array" type="button" id="PMC::TEST::VAR4" name="PMC::TEST::VAR4"></button></br>
            <input type="submit" value="Update values"></input>
        </form></br>
        
        <form id="loadScheduleForm">
            <select id="schselect" name="schselect"></select>
            <input type="submit" value="Load from schedule"></input>
        </form></br>

        <form id="setReferenceForm">
            <select id="refselect" name="refselect">
                <option value="none" text="none">None</option>
                <option value="plant" text="plant">Plant</option>
            </select>
            <input type="submit" value="Set reference"></input>
        </form></br>
            
        <input type="button" value="Load from plant" onclick="loadFromPlant()"></input>
    </body>
</html>

