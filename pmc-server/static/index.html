<html>
    <head>
        </script>
        <link rel="import" href="libraries.html">
        <link rel="import" href="pmc-input.html">
        <link rel="import" href="pmc-library.html">
        <link rel="import" href="pmc-array-editor.html">
        <link rel="import" href="pmc-cubicle-editor.html">
        <link rel="import" href="pmc-switch.html">
        <link rel="import" href="pmc-switch-editor.html">
        <link rel="import" href="pmc-filter-editor.html">
        <!-- Handle SSE events from the server-->
        <script>
            var eventOutputContainer = document.getElementById("event");
            var evtSrc = new EventSource("/stream");
            //Changed values are received in json format
            evtSrc.onmessage = function(e) {
                var jsonPlantVariables = $.parseJSON(e.data);
                var plantVariables = jsonPlantVariables["plantVariables"];
                var i;
                for (i in plantVariables) {
                    var pv = plantVariables[i];
                    var targetElement = allPMCComponents[pv.name];
                    if (targetElement !== null) {
                        targetElement.setPlantValue(pv.value);
                        targetElement.checkValues();
                    }
                }
            };
        </script>

        <script>
            //Submit new values to update the plant 
            $(function () {
                $("#updatePlantForm").on("submit", function (e) {
                    e.preventDefault();
                    var allPMCDataJSon = {};
                    $.each(allPMCComponents, function (i, pmcComp) {
                        allPMCDataJSon[pmcComp.id] = pmcComp.getValue();
                    });
                    var dataToSend = "update=" + JSON.stringify(allPMCDataJSon);
                    $.ajax({
                        type: "get",
                        url: "/submit",
                        data: dataToSend,
                        success: function (response) {
                            if (response == "done") {
                                alert("Values updated successfully!");
                                $.each(allPMCComponents, function (i, pmcComp) {
                                    pmcComp.setInitialValue(pmcComp.getValue());
                                    pmcComp.checkValues();
                                });
                            } 
                            else {
                                alert("Form submission failed!");
                            }
                        },
                        error: function (response) {
                            console.log(response);
                            alert(response);
                        }
                    });
                });
            });

            //Set parameters as reference
            $(function () {
                $("#setReferenceForm").on("submit", function (e) {
                    e.preventDefault();
                    //Check if the refence to set is none
                    var currentReference = document.getElementById("refselect").value;
                    if (currentReference === "none") {
                        //Reset all the values to N/A
                        $.each(allPMCComponents, function (i, pmcComp) {
                            pmcComp.setReferenceValue("N/A");
                            pmcComp.setReference(currentReference);
                            pmcComp.checkValues();
                        });
                    }
                    else if (currentReference === "plant") {
                        //Reset all the values to N/A
                        $.each(allPMCComponents, function (i, pmcComp) {
                            pmcComp.setReferenceValue(pmcComp.getPlantValue());
                            pmcComp.setReference(currentReference);
                            pmcComp.checkValues();
                        });
                    }
                    else {
                        var getParams = $(this).serialize();
                        //Replace the refselect with schselect to avoid collision of the two drop box
                        getParams = getParams.replace("refselect", "schselect");
                        console.log(getParams);
                        $.ajax({
                            type: "get",
                            url: "/getschedule",
                            data: getParams,
                            success: function (response) {
                                variables = $.parseJSON(response);
                                $.each(variables, function(i, variable) {
                                    var targetElement = allPMCComponents[variable.name];
                                    if (targetElement != null) {
                                        targetElement.setReferenceValue(variable.value);
                                        targetElement.setReference(currentReference);
                                        targetElement.checkValues();
                                    }
                                });
                            },
                            error: function (response) {
                                console.log(response);
                                alert(response);
                            }
                        });
                    }
                });
            });

            //Load parameters from a schedule
            $(function () {
                $("#loadScheduleForm").on("submit", function (e) {
                    e.preventDefault();
                    $.ajax({
                        type: "get",
                        url: "/getschedule",
                        data: $(this).serialize(),
                        success: function (response) {
                            variables = $.parseJSON(response);
                            $.each(variables, function(i, variable) {
                                var targetElement = allPMCComponents[variable.name];
                                if (targetElement != null) {
                                    targetElement.setValue(variable.value);
                                    targetElement.checkValues();
                                }
                            });
                        },
                        error: function (response) {
                            console.log(response);
                            alert(response);
                        }
                    });
                });
            });

            //Get all the available libraries
        </script>

        <script>
            $(document).ready(function() {
                //Load available schedule names. 
                $.ajax({
                    type: "get",
                    url: "/getschedules",
                    success: function (response) {
                        var scheduleNames = $.parseJSON(response);
                        $.each(scheduleNames, function(i, scheduleName) {
                            $("#schselect").append($("<option>", {
                                value: scheduleName,
                                text: scheduleName
                            }));
                        });
                        $.each(scheduleNames, function(i, scheduleName) {
                            $("#refselect").append($("<option>", {
                                value: scheduleName,
                                text: scheduleName
                            }));
                        });
                    },
                    error: function (response) {
                        console.log(response);
                        alert(response);
                    }
                });

                //Load all the types
                $.ajax({
                    type: "get",
                    url: "/getplantinfo",
                    success: function (response) {
                        var pvInfosJson = $.parseJSON(response);
                        var pvInfos = pvInfosJson["variables"];
                        $.each(pvInfos, function(i, pvInfo) {
                            var targetElement = allPMCComponents[pvInfo.name];
                            if (targetElement != null) {
                                console.log(pvInfo.name);
                                targetElement.setTypeValue(pvInfo.type);
                                targetElement.setLibrary(pvInfo.library.toLowerCase() === "true");
                                targetElement.setNumberOfElements(pvInfo.numberOfElements);
                                targetElement.setReference("none");
                                targetElement.setInitialValue(pvInfo.value);
                                targetElement.setValue(pvInfo.value);
                                targetElement.checkValues();
                            }
                        });
                    },
                    error: function (response) {
                        console.log(response);
                        alert(response);
                    }
                });

                //Load all the librariesj
                $.ajax({
                    type: "get",
                    url: "/getlibraries",
                    success: function (response) {
                        var librariesJson = $.parseJSON(response);
                        var allLibraries = librariesJson["libraries"];
                        $.each(allLibraries, function(i, librariesJson) {
                            var targetElement = allPMCComponents[librariesJson.variable];
                            if (targetElement != null) {
                                targetElement.availableLibraries = librariesJson.names;
                            }
                        });
                    },
                    error: function (response) {
                        console.log(response);
                        alert(response);
                    }
                });

                $.each(allPMCComponents, function (i, pmcComp) {
                    pmcComp.domLoaded();
                });


            });

            function loadFromPlant() {
                $.each(allPMCComponents, function (i, pmcComp) {
                    pmcComp.setValue(pmcComp.getPlantValue());
                    pmcComp.checkValues();
                });
            }
        </script>
    </head>
    <body>
        <h1>PMC Example 1</h1>
        <div id="event"></div>
        <form id="updatePlantForm">
            <table border="0">
                <tr>
                    <td>PMC::TEST::VAR1</td>
                    <td><input is="pmc-input" type="text" id="PMC::TEST::VAR1" name="PMC::TEST::VAR1"></input></td>
                </tr>
                <tr>
                    <td>PMC::TEST::VAR2</td>
                    <td><input is="pmc-input" type="text" id="PMC::TEST::VAR2" name="PMC::TEST::VAR2"></input></td>
                </tr>
                <tr>
                    <td>PMC::TEST::VAR3</td>
                    <td><button is="pmc-library" data-library-editor="pmc-array-editor" type="button" id="PMC::TEST::VAR3" name="PMC::TEST::VAR3"></button></td>
                </tr>
                <tr>
                    <td>PMC::TEST::VAR4</td>
                    <td><button is="pmc-library" data-library-editor="pmc-array-editor" type="button" id="PMC::TEST::VAR4" name="PMC::TEST::VAR4"></button></td>
                </tr>
                <tr>
                    <td>PMC::TEST::VAR7</td>
                    <td><button is="pmc-library" data-library-editor="pmc-filter-editor" type="button" id="PMC::TEST::VAR7" name="PMC::TEST::VAR7"></button></td>
                </tr>
                <tr>
                    <td>PMC::TEST::VAR5</td>
                    <td><pmc-array-editor is="pmc" id="PMC::TEST::VAR5" name="PMC::TEST::VAR5"></pmc-array-editor></td>
                </tr>
                <tr>
                    <td>PMC::TEST::VAR6</td>
                    <td><pmc-filter-editor is="pmc" id="PMC::TEST::VAR6" name="PMC::TEST::VAR6"></pmc-filter-editor></td>
                </tr>
            </table>
            <input type="submit" value="Update values"></input>
        </form></br>
        
        <form id="loadScheduleForm">
            <select id="schselect" name="schselect"></select>
            <input type="submit" value="Load from schedule"></input>
        </form></br>

        <form id="setReferenceForm">
            <select id="refselect" name="refselect">
                <option value="none" text="none">None</option>
                <option value="plant" text="plant">Plant</option>
            </select>
            <input type="submit" value="Set reference"></input>
        </form></br>
            
        <input type="button" value="Load from plant" onclick="loadFromPlant()"></input>
        <br/>

        <pmc-cubicle-editor is="pmc" id="PMC::TEST::VAR8">
            <pmc-switch is="pmc" id="PMC::TEST::VAR9" data-library-editor="pmc-switch-editor" data-location-cubicle="0">
            </pmc-switch>
            <pmc-switch is="pmc" id="PMC::TEST::VAR10" data-library-editor="pmc-switch-editor" data-location-cubicle="2">
            </pmc-switch>
        </pmc-cubicle-editor>
<!--        <pmc-switch is="pmc" id="PMC::TEST::VAR11" data-library-editor="pmc-switch-editor">
        </pmc-switch>-->
    </body>
</html>

