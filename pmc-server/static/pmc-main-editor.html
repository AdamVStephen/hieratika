<html>
    <head>
        <link rel="import" href="libraries.html">
        <link rel="import" href="pmc-component.html">
        <link rel="import" href="libraries.html">
        <link rel="import" href="pmc-array-editor.html">
        <link rel="import" href="pmc-cubicle-editor.html">
        <link rel="import" href="pmc-discrete-coils-2d.html">
        <link rel="import" href="pmc-loop-coils-3d.html">
        <link rel="import" href="pmc-filter-editor.html">
        <link rel="import" href="pmc-input.html">
        <link rel="import" href="pmc-library-button.html">
        <link rel="import" href="pmc-struct-browser.html">
        <link rel="import" href="pmc-switch.html">
        <link rel="import" href="pmc-switch-editor.html">
    </head>
    <body>
        <template id="tmaineditor">
            <iframe id="dmaineditor" style="position: absolute; height: 100%; width: 100%; border: none">
            </iframe>
        </template>

        <script>
            //This is enclosure is required to protect the importDoc
            (function () {
                var importDoc = document.currentScript.ownerDocument; // importee
                //Constructor
                class PMCMainEditor extends HTMLElement {
                    constructor() {
                        super();
                    }

                    createdCallback () {
                        var template = importDoc.querySelector("#tmaineditor");
                        var clone = document.importNode(template.content, true);
                        var root = this.createShadowRoot();
                        root.appendChild(clone);
                        var templateDiv = this.shadowRoot.querySelector("#dmaineditor");

                        this.plantInfoLoadedListeners = [this];
                        parent._pmcMainEditor = this;
                    }

                    attachedCallback() {
                        var topNav = document.getElementById("top-nav");
                        topNav.addPageListener(this); 
                        topNav.addUserLogoutListener(this);
                        //Cannot be done from the topNav since the topNav createdCallback and attachedCallback are called before the mainEditor created and attached callbacks
                        this.addPlantInfoLoadedListener(topNav);
                    }

                    addPlantInfoLoadedListener(listener) {
                        this.plantInfoLoadedListeners.push(listener);
                    }

                    firePlantInfoLoaded() {
                        for(var l in this.plantInfoLoadedListeners) {
                            this.plantInfoLoadedListeners[l].plantInfoLoaded();
                        }
                    }

                    loadPlantInfo() {
                        var allVariableIds = [];
                        for (var k in parent._allPMCComponents) {
                            allVariableIds.push(k)
                        }
                        getPlantInfo(allVariableIds, function (response) {
                            var pvInfosJson = $.parseJSON(response);
                            var pvInfos = pvInfosJson["variables"];
                            var user = JSON.parse(localStorage.user);
                            for (var i in pvInfos) {
                                var pvInfo = pvInfos[i];
                                var targetElements = parent._allPMCComponents[pvInfo.variableId];
                                if (targetElements != null) {
                                    for (var j in targetElements) {
                                        populateComponentInfo(targetElements[j], pvInfo, user);                    
                                    }
                                }
                            }

                            this.firePlantInfoLoaded();
                        }.bind(this),
                        );
                    }

                    iFrameLoaded() {
                        this.loadPlantInfo(); 

                        $.each(parent._allPMCComponents, function (i, pmcCompArray) {
                            $.each(pmcCompArray, function (j, pmcComp) {
                                pmcComp.domLoaded();
                            });
                        });
                    }

                    pageChanged (page) {
                        parent._allPMCComponents = {};
                        //Remove all the listeners (apart from this and the pmc-top-nav)
                        this.plantInfoLoadedListeners = this.plantInfoLoadedListeners.slice(0, 2);
                        var pageUrl = page.id + ".html?" + new Date().getTime(); //new Date... to force reloading with no caching
                        var templateDiv = this.shadowRoot.querySelector("#dmaineditor");
                        templateDiv.onload = function(evt) {
                            this.iFrameLoaded();
                        }.bind(this);
                        templateDiv.src = pageUrl;
                        
                        /*
                        if (pageUrl !== undefined) {
                            $.ajax({
                                type: "GET",
                                url: pageUrl,
                                success: function (response) {
                                    parent._allPMCComponents = {};
                                                                        
                                    templateDiv.innerHTML = response;

                                    //eval to execute any embedded js in the page.
                                    var htmlJs = templateDiv.getElementsByTagName("script");   
                                    if (htmlJs !== undefined) {
                                        for(var i=0;i<htmlJs.length;i++) {  
                                            eval(htmlJs[i].text);  
                                        }
                                    }
                                    

                                    this.loadPlantInfo(); 

                                    $.each(parent._allPMCComponents, function (i, pmcCompArray) {
                                        $.each(pmcCompArray, function (j, pmcComp) {
                                            pmcComp.domLoaded();
                                        });
                                    });

                                }.bind(this),
                                error: function (response) {
                                    console.log(response);
                                    alert(response);
                                }
                            });
                        }*/
                    }
   
                    plantInfoLoaded() {
                        displayPlant();
                    } 

                    userLogout () {
                        var templateDiv = this.shadowRoot.querySelector("#dmaineditor");
                        templateDiv.innerHTML = "";
                    }
                }
                document.registerElement("pmc-main-editor", {
                    prototype: PMCMainEditor.prototype,
                });
            })(); 
        </script>
    </body>
</html>
