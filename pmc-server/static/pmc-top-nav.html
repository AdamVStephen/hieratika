<!DOCTYPE html>
<html>
<head>
    <link rel="import" href="pmc-helper.html">
    <link rel="import" href="pmc-login.html">
    <link rel="import" href="pmc-schedule.html">
    <link rel="import" href="pmc-schedule-selector.html">
</head>
<body>
    <style>
        ::shadow button{
            height: 30px;
        }

        ::shadow select {
            height: 30px;
        }
    </style>
    <template id="ttopnav">
        <table>
            <tr>
                <td><button title="Load current values into plant" id="loadplantbtn" disabled="true">Load</button></td>
                <td style="padding-left:50px;">
                    <select id="pageselect" name="pageselect">
                    </select>
                </td>
                <td><button title="Set the current pages" id="pageselectbtn" disabled="true">Change page</button></td>
                <td><button title="Set the current schedule" id="changeshedulebtn" disabled="true">Change schedule</button></td>
        
                <td style="padding-left:50px">
                    <table style="border-style: dotted; border-width: 1px;">
                        <td><button title="Remove the compare reference" id="refselectnonebtn" disabled="true"><img width="24px" height="24px" src="icons/reference-set-none-24.png"/></button></td>
                        <td><button title="Set the plant as the compare reference" id="refselectplantbtn" disabled="true"><img width="24px" height="24px" src="icons/reference-set-plant-24.png"/></button></td>
                        <td><button title="Set another schedule as the compare reference" id="refselectschedulebtn" disabled="true"><img width="24px" height="24px" src="icons/reference-set-schedule-24.png"/></button></td>
                    </table>
                </td>

                <td style="padding-left:50px">
                    <table style="border-style: dotted; border-width: 1px;">
                        <td><button title="Copy from the plant" id="cpyreferenceplantbtn" disabled="true"><img width="24px" height="24px" src="icons/reference-copy-plant-24.png"/></button></td>
                        <td><button title="Copy from a given schedule" id="cpyreferenceschedulebtn" disabled="true"><img width="24px" height="24px" src="icons/reference-copy-schedule-24.png"/></button></td>
                    </table>
                </td>

                <td style="padding-left:50px;">
                    <button title="Commit all changes to current schedule" id="commitbtn" disabled="true">Commit</button>
                    <button title="Undo all changes" id="undobtn" disabled="true">Undo</button>
                </td>

                <td style="padding-left:50px;color:white" id="username">...</td>
                <td style="color:white" id="currentSchedule">(@...)</td>
                <td><button title="Login" id="loginbtn">Login</button></td>
            </tr>
        </table>
        <pmc-login id="pmclogin"></pmc-login>
        <pmc-schedule id="pmcschedule"></pmc-schedule>
        <pmc-schedule-selector id="referencescheduleselector"></pmc-schedule-selector>
        <pmc-schedule-selector id="copyscheduleselector"></pmc-schedule-selector>
    </template>

    <script>
        //This is enclosure is required to protect the importDoc
        (function () {
            var importDoc = document.currentScript.ownerDocument; // importee
            class PMCTopNav extends HTMLElement {
                constructor() {
                    super();
                }

                createdCallback () {
                    var template = importDoc.querySelector("#ttopnav");
                    if (template !== undefined) {
                        // import template into
                        var clone = document.importNode(template.content, true);
                        var root = this.createShadowRoot();
                        root.appendChild(clone);

                        this.mainEditor = document.getElementById("main-editor");

                        this.loadPlantButton = this.shadowRoot.querySelector("#loadplantbtn");
                        this.loadPlantButton.onclick = function() {
                            loadIntoPlant();
                        }.bind(this); 

                        this.pageSelectButton = this.shadowRoot.querySelector("#pageselectbtn");
                        this.loginButton = this.shadowRoot.querySelector("#loginbtn");
                        var loginDialog = this.shadowRoot.querySelector("#pmclogin");
                        loginDialog.addLoginListener(this);
                        this.loginButton.onclick = function() {
                            if (localStorage.user === undefined) {
                                loginDialog.show();
                            }
                            else {
                                this.fireUserLogout();
                            }
                        }.bind(this);

                        this.pageSelectButton.onclick = function() {
                            this.pageSelectButton.disabled = true;
                            this.getSelectedPage();     
                        }.bind(this);
                        
                        var scheduleDialog = this.shadowRoot.querySelector("#pmcschedule");
                        scheduleDialog.addCurrentScheduleListener(this);
                        this.changeScheduleButton = this.shadowRoot.querySelector("#changeshedulebtn");
                        this.changeScheduleButton.onclick = function() {
                            scheduleDialog.show();
                        }.bind(this);

                        this.usernameTd = this.shadowRoot.querySelector("#username");
                        this.currentScheduleTd = this.shadowRoot.querySelector("#currentSchedule");

                        if (localStorage.user === undefined) {
                            this.loginButton.innerHTML = "Login";
                        }
                        else {
                            var user = JSON.parse(localStorage.user);
                            currentToken = localStorage.currentToken;
                            this.loginSuccessful(user);
                        }
  
                        this.referenceScheduleSelector = this.shadowRoot.querySelector("#referencescheduleselector");
                        this.copyScheduleSelector = this.shadowRoot.querySelector("#copyscheduleselector");
                        this.pageSelect = this.shadowRoot.querySelector("#pageselect");

                        this.referenceSelectNoneButton = this.shadowRoot.querySelector("#refselectnonebtn");
                        this.referenceSelectNoneButton.onclick = function () {
                            setReference("none");
                        }.bind(this);

                        this.referenceSelectPlantButton = this.shadowRoot.querySelector("#refselectplantbtn");
                        this.referenceSelectPlantButton.onclick = function () {
                            setReference("plant");
                        }.bind(this);


                        this.referenceSelectScheduleButton = this.shadowRoot.querySelector("#refselectschedulebtn");
                        this.referenceSelectScheduleButton.onclick = function () {
                            this.referenceScheduleSelector.show(this.refererenceScheduleChanged);
                        }.bind(this); 

                        this.copyFromReferenceScheduleButton = this.shadowRoot.querySelector("#cpyreferenceschedulebtn");
                        this.copyFromReferenceScheduleButton.onclick = function () {
                            this.referenceScheduleSelector.show(this.copyFromScheduleChanged);
                        }.bind(this);

                        this.copyFromReferencePlantButton = this.shadowRoot.querySelector("#cpyreferenceplantbtn");
                        this.copyFromReferencePlantButton.onclick = function () {
                            $.each(allPMCComponents, function (i, pmcComp) {
                                pmcComp.setValue(pmcComp.getPlantValue());
                            });
                        }.bind(this);


                        this.commitButton = this.shadowRoot.querySelector("#commitbtn");
                        this.commitButton.onclick = function () {
                            commitAllChangesToSchedule();
                        }

                        this.undoButton = this.shadowRoot.querySelector("#undobtn");
                        this.undoButton.onclick = function () {
                            undoAllChangesToSchedule();
                        }

                        this.pageListeners = [this];
                        this.userLogoutListeners = [this];
                        this.addPageListener(scheduleDialog);
                        this.addPageListener(this.referenceScheduleSelector);
                        this.addPageListener(this.copyScheduleSelector);
                    }
                }

                getSelectedPage() {
                    var pgId = this.pageSelect[this.pageSelect.selectedIndex].value;
                    $.ajax({
                        type: "post",
                        url: "/getpage",
                        data: {
                            token: currentToken,
                            pageId: pgId
                        },
                        success: function (response) {
                            var pageJson = $.parseJSON(response);
                            this.firePageChanged(pageJson);
                            this.pageSelectButton.disabled = false;
                        }.bind(this),
                        error: function (response) {
                            console.log(response);
                            alert(response);
                        }
                    });
                }

                getPages() {
                    $.ajax({
                        type: "post",
                        url: "/getpages",
                        data: {
                            token: currentToken,
                        },
                        success: function (response) {
                            var pagesJson = $.parseJSON(response);
                            this.pageSelect = this.shadowRoot.querySelector("#pageselect");
                            this.pageSelect.innerHTML = "";
                            for (var p in pagesJson) {
                                var option1 = document.createElement("option");
                                var pageId = pagesJson[p].id;
                                option1.text = pageId;
                                option1.value = pageId;
                                this.pageSelect.appendChild(option1);
                            }
                        }.bind(this),
                        error: function (response) {
                            console.log(response);
                            alert(response);
                        }
                    });
                }

                loginSuccessful(user) {
                    this.usernameTd.innerHTML = user.name; 
                    this.usernameTd.title = "username: " + user.id;

                    this.loginButton.innerHTML = "Logout";

                    this.getPages(); 
                    this.pageSelectButton.disabled = false;
                }
                
                currentScheduleChanged(schedule) {
                    this.currentScheduleTd.innerHTML = "(@ " + schedule.id + ")"; 
                    copyFromSchedule(schedule.id, true, false);
                    localStorage.currentSchedule = JSON.stringify(schedule);
                    this.loadPlantButton.disabled = false;
                }

                firePageChanged(page) {
                    for(var l in this.pageListeners) {
                        this.pageListeners[l].pageChanged(page);
                    }
                }

                fireUserLogout() {
                    for(var l in this.userLogoutListeners) {
                        this.userLogoutListeners[l].userLogout();
                    }
                }

                userLogout() {
                    localStorage.removeItem("user");
                    localStorage.removeItem("schedule");
                    this.usernameTd.innerHTML = "...";
                    this.currentScheduleTd.innerHTML = "(@...)"; 
                    this.loginButton.innerHTML = "Login";
                    this.loadPlantButton.disabled = true;
                    this.changeScheduleButton.disabled = true;
                    this.pageSelectButton.disabled = true;
                    this.referenceSelectScheduleButton.disabled = true;
                    this.referenceSelectNoneButton.disabled = true;
                    this.referenceSelectPlantButton.disabled = true;
                    this.copyFromReferenceScheduleButton.disabled = true;
                    this.copyFromReferencePlantButton.disabled = true;
                    this.commitButton.disabled = true;
                    this.undoButton.disabled = true;
                }

                pageChanged(page) {
                    this.changeScheduleButton.disabled = false;
                    $.ajax({
                        type: "post",
                        url: "/getschedules",
                        data: {
                            token: currentToken,
                            pageId: page.id
                        },
                        success: function (response) {
                            var availableSchedules = $.parseJSON(response);
                            this.referenceSelectScheduleButton.disabled = false;
                            this.referenceSelectNoneButton.disabled = false;
                            this.referenceSelectPlantButton.disabled = false;
                            this.copyFromReferenceScheduleButton.disabled = false;
                            this.copyFromReferencePlantButton.disabled = false;
                            this.commitButton.disabled = false;
                            this.undoButton.disabled = false;
                        }.bind(this),
                        error: function (response) {
                            console.log(response);
                            alert(response);
                        }
                    });
                }

                refererenceScheduleChanged(schId) {
                    setReference(schId);
                }

                copyFromScheduleChanged(schId) {
                    copyFromSchedule(schId, false, true);
                }

                addPageListener(listener) {
                    this.pageListeners.push(listener);
                }
    
                addUserLogoutListener(listener) {
                    this.userLogoutListeners.push(listener);
                }

            }

            document.registerElement("pmc-top-nav", {
                prototype: PMCTopNav.prototype,
            });

        }());
    </script>
</body>
</html>
