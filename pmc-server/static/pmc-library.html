<html>
    <head>
        <link rel="import" href="libraries.html">
        <link rel="import" href="pmc-abstract-input.html">
        <link rel="import" href="pmc-library-editor.html">
    </head>
    <body>
        <script>
            class PMCLibrary extends PMCAbstractInput {
                constructor() {
                    super();
                }

                attachLibraryHandler () {
                    this.availableLibraries = [];
                    //Create an editor
                    var libraryVariables = this.getAttribute("data-library-variables");
                    var libraryEditorUrl = this.getAttribute("data-library-editor");
                    this.libraryEditor = this.shadowRoot.querySelector("#tlibrary-editor");

                    //Attach a selector
                    this.libraryEditor.setOwnerComponent(this);
                    if (libraryVariables === undefined) {
                        libraryVariables = "{}";
                    }
                    this.libraryEditor.setLibraryVariables(libraryEditorUrl, JSON.parse(libraryVariables));
                }

                getAvailableLibraries() {
                    var allPMCLibVariablesJSon = [this.id];
                    $.ajax({
                        type: "post",
                        url: "/getlibraries",
                        data: {
                            token: parent._currentToken,
                            variables: JSON.stringify(allPMCLibVariablesJSon)
                        },
                        success: function (response) {
                            var librariesJson = $.parseJSON(response);
                            var allLibraries = librariesJson["libraries"];
                            if (librariesJson.ids !== undefined) {
                                this.setAvailableLibraries(librariesJson.ids);
                            }
                            this.libraryEditor.showSelector(this.availableLibraries, this.getValue());
                        }.bind(this),
                        error: function (response) {
                            console.log(response);
                            alert(response);
                        }
                    });
                }

                showLibraryEditor () {
                    //document.body.appendChild(this.libraryEditor);
                    this.getAvailableLibraries();
                }
            
                setAvailableLibraries(libraries) {
                    //copy the array
                    this.availableLibraries = libraries.slice();
                }

                addAvailableLibrary(library) {
                    this.availableLibraries.push(library);
                } 

                setReadOnly (isReadOnly) {
                    super.setReadOnly(isReadOnly);
                    this.libraryEditor.setReadOnly(isReadOnly);
                }

                setUserAllowedToWrite (isUserAllowedToWrite) {
                    super.setUserAllowedToWrite(isUserAllowedToWrite);
                    this.libraryEditor.setUserAllowedToWrite(isUserAllowedToWrite);
                }

                libraryChanged (newLibraryName) {
                }
            }
        </script>
    </body>
</html>
