<html>
<head>
    <link rel="import" href="pmc-helper.html">
</head>
</body>
    <template id="tscheduleselector">
        <dialog id="dscheduleselector">
            <div id="divschedule">
                <table style="border-style:solid;border-width:1px;width: 100%">
                    <tr>
                        <td>
                            User
                        </td>
                        <td>
                            Schedules 
                        </td>
                        <td>
                            Description
                        </td>
                    </tr>
                    <tr>
                        <td><select id="userselect" size="20" style="width:150px;overflow-x:scroll"></select></td>
                        <td><select id="scheduleselect" size="20" style="width:150px;overflow-x:scroll"></select></td>
                        <td id="descriptionarea" style="width:250px;vertical-align:top;background-color:#F5F5F5"></td>
                    </tr>
                </table>
                <table style="border-style:solid;border-width:0px;width: 100%">
                    <tr>
                        <td style="padding-top:20px;">
                            <button title="OK" id="okbtn">OK</button>
                            <button title="Cancel" id="cancelbtn">Cancel</button>
                        </td>
                         <td style="padding-top:20px;text-align:right;">
                            <button title="Create a new schedule..." id="createschedulebtn">New schedule...</button>
                        </td>
                   </tr>
                </table>
            </dialog>
        </div>
        <div id="divnewschedule" hidden>
            <table style="border-style:solid;border-width:1px;width: 100%">
                <tr>
                    <td>Schedule name:</td>
                    <td><input type="text" id="newschedulename"></input></td>
                </tr>
                <tr>
                    <td>Schedule description:</td>
                    <td><textarea rows="4" cols="30" id="newscheduledescription" title="Description"></textarea></td>
                </tr>
                <tr>
                    <td>Copy from:</td>
                    <td>
                        <select id="newschedulesselect" name="newschedulesselect">
                        </select>
                    </td>
                </tr>
            </table>
            <table style="border-style:solid;border-width:0px;width: 100%">
                <tr>
                    <td style="padding-top:20px;">
                        <button title="OK" id="oknewschedulebtn">OK</button>
                        <button title="Cancel" id="cancelnewschedulebtn">Cancel</button>
                    </td>
                </tr>
            </table>
        </div>
    </template>

    <script>
        //This is enclosure is required to protect the importDoc
        (function () {
            var importDoc = document.currentScript.ownerDocument; // importee
            class PMCScheduleSelector extends HTMLElement {
                constructor() {
                    super();
                }

                createdCallback () {
                    var template = importDoc.querySelector("#tscheduleselector");
                    if (template !== undefined) {
                        // import template into
                        var clone = document.importNode(template.content, true);
                        var root = this.createShadowRoot();
                        root.appendChild(clone);
                  
                        this.pageName = ""; 
                        this.diag = this.shadowRoot.querySelector("#dscheduleselector");
                        this.userSelect = this.shadowRoot.querySelector("#userselect");
                        this.userSelect.onclick = function() {
                            this.okButton.disabled = true;
                            this.updateUserSchedules(); 
                        }.bind(this);

                        this.scheduleSelect = this.shadowRoot.querySelector("#scheduleselect");
                        this.scheduleSelect.onclick = function() {
                            this.updateScheduleDescription();
                        }.bind(this);
                        
                        this.descriptionArea = this.shadowRoot.querySelector("#descriptionarea");
                        this.okButton = this.shadowRoot.querySelector("#okbtn");
                        this.okButton.onclick = function() {
                            var schedule = this.scheduleSelect[this.scheduleSelect.selectedIndex].scheduleInfo;
                            this.okCallbackFunction(schedule);
                            this.diag.close();
                        }.bind(this);

                        var cancelButton = this.shadowRoot.querySelector("#cancelbtn");
                        cancelButton.onclick = function() {
                            this.diag.close();
                        }.bind(this); 

                        this.scheduleDiv = this.shadowRoot.querySelector("#divschedule");
                        this.newScheduleDiv = this.shadowRoot.querySelector("#divnewschedule");
                        this.newSchedulesSelect = this.shadowRoot.querySelector("#newschedulesselect");
                        this.newScheduleName = this.shadowRoot.querySelector("#newschedulename")
                        this.newScheduleDescription = this.shadowRoot.querySelector("#newscheduledescription")
                        var createNewSchedule = this.shadowRoot.querySelector("#createschedulebtn");
                        createNewSchedule.onclick = function() {
                            this.scheduleDiv.setAttribute("hidden", "true");
                            this.newScheduleDiv.removeAttribute("hidden");
                            this.newScheduleName.value = (new Date().toISOString());
                            this.newScheduleDescription.value = "Schedule created on the " + this.newScheduleName.value;

                            this.newSchedulesSelect.innerHTML = "";
                            var option1 = document.createElement("option");
                            var scheduleName = PLANT_NAME;
                            option1.text = scheduleName;
                            option1.value = scheduleName;
                            this.newSchedulesSelect.appendChild(option1);
                            
                            if ((this.userSelect.selectedIndex >= 0) && (this.scheduleSelect.selectedIndex >= 0)) {
                                var username = this.userSelect[this.userSelect.selectedIndex].value;
                                var schedule = this.scheduleSelect[this.scheduleSelect.selectedIndex].scheduleInfo;
                                option1 = document.createElement("option");
                                scheduleName = schedule.name + " (owner: " + username + ")";
                                option1.text = scheduleName;
                                option1.value = schedule.uid;
                                this.newSchedulesSelect.appendChild(option1);
                            }
                        }.bind(this); 

                        var cancelNewScheduleButton = this.shadowRoot.querySelector("#cancelnewschedulebtn");
                        cancelNewScheduleButton.onclick = function() {
                            this.scheduleDiv.removeAttribute("hidden");
                            this.newScheduleDiv.setAttribute("hidden", "true");
                        }.bind(this); 

                        var okNewScheduleButton = this.shadowRoot.querySelector("#oknewschedulebtn");
                        okNewScheduleButton.onclick = function() {
                            var schedule = {
                                token: parent._currentToken,
                                name: this.newScheduleName.value,
                                description: this.newScheduleDescription.value,
                                pageName: this.pageName
                            }
                            var user = JSON.parse(localStorage.user);
                            schedule["username"] = user.username;
                            if (this.newSchedulesSelect.selectedIndex > 0) {
                                schedule["sourceScheduleUID"] = this.newSchedulesSelect[this.newSchedulesSelect.selectedIndex].value;
                            }
                            $.ajax({
                                type: "post",
                                url: "/createschedule",
                                data: schedule,
                                success: function (response) {
                                    this.scheduleDiv.removeAttribute("hidden");
                                    this.newScheduleDiv.setAttribute("hidden", "true");
                                    this.updateUserSchedules();
                                }.bind(this),
                                error: function (response) {
                                    console.log(response);
                                    alert(response);
                                }
                            });
                        }.bind(this); 
                    }
                }

                updateScheduleDescription() {
                    if (this.userSelect.selectedIndex >= 0) {
                        var username = this.userSelect[this.userSelect.selectedIndex].value;
                        if (this.scheduleSelect.selectedIndex >= 0) {
                            if (this.currentUsername !== undefined) {
                                this.okButton.disabled = (this.currentUsername !== username);
                            }
                            else {
                                this.okButton.disabled = false;
                            }
                            this.descriptionArea.innerHTML = this.scheduleSelect[this.scheduleSelect.selectedIndex].scheduleInfo.description;
                        }
                    }

                }

                updateUserSchedules() {
                    if (this.userSelect.selectedIndex >= 0) {
                        var username = this.userSelect[this.userSelect.selectedIndex].value;
                        $.ajax({
                            type: "post",
                            url: "/getschedules",
                            data: {
                                token: parent._currentToken,
                                username : username,
                                pageName: this.pageName
                            },
                            success: function (response) {
                                var availableSchedules = $.parseJSON(response);
                                this.scheduleSelect.innerHTML = "";
                                if (availableSchedules.length === 0) {
                                    this.scheduleSelect.disabled = true;
                                    var option1 = document.createElement("option");
                                    option1.text = "No schedule available...";
                                    option1.value = NONE_NAME;
                                    this.scheduleSelect.appendChild(option1);
                                }
                                else {
                                    this.scheduleSelect.disabled = false;
                                    for (var s in availableSchedules) {
                                        var scheduleName = String(availableSchedules[s].name);
                                        var option1 = document.createElement("option");
                                        option1.text = scheduleName;
                                        option1.value = scheduleName;
                                        option1.scheduleInfo = availableSchedules[s];
                                        this.scheduleSelect.appendChild(option1);
                                    }
                                }
                            }.bind(this),
                            error: function (response) {
                                console.log(response);
                                alert(response);
                            }
                        });
                    }
                }

                pageChanged(page) {
                    this.pageName = page.name;
                }

                show(okCallbackFun, currentUsername = undefined) {
                    this.currentUsername = currentUsername;
                    this.okCallbackFunction = okCallbackFun;
                    this.okButton.disabled = true;
                    this.scheduleSelect.disabled = true;
                    this.userSelect.innerHTML = "";
                    this.scheduleSelect.innerHTML = "";
                    var option1 = document.createElement("option");
                    option1.text = "Select user";
                    option1.value = NONE_NAME;
                    this.scheduleSelect.appendChild(option1);
                    for (var u in parent._allUsers) {
                        option1 = document.createElement("option");
                        var username = parent._allUsers[u].username;
                        option1.text = username;
                        option1.value = username;
                        this.userSelect.appendChild(option1);
                    }
                    this.diag.showModal();
                }
            }

            document.registerElement("pmc-schedule-selector", {
                prototype: PMCScheduleSelector.prototype,
            });

        }());
    </script>

    </body>
</html>
