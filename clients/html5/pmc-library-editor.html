<html>
    <head>
        <link rel="import" href="libraries.html">
    </head>
    <body>
        <template id="tselector">
            <dialog id="dselector">
                <iframe id="iframeeditor" style="width: 100%;border-style:solid;border-width:1px;"></iframe>
                </br>
                <table style="border-style:solid;border-width:1px;width: 100%">
                    <tr>
                        <td><select id="tselect" name="tselect"></select></td>
                        <td><button id="saveAsButton">Save as...</button><input type="text" id="saveAsLibraryName"></input></td>
                    </tr>
                    <tr>
                        <td colspan="3"><textarea rows="2" cols="60" id="descriptionTextArea" title="Description"></textarea></td>
                    </tr>
                </table>
                </br>
                <table style="border-style:solid;border-width:1px;width: 100%">
                    <tr>
                        <td><button id="tselectorOK">OK</button><button id="tselectorCancel">Cancel</button></td>
                    </tr>
                </table>
            </dialog>
        </template>
        <script>
            (function () {
                var importDoc = document.currentScript.ownerDocument; // importee

                class PMCLibraryEditor extends HTMLElement {
                    constructor() {
                        super();
                    }

                    getLibraryUID (libraryName) {
                        var allLibraries = this.owner.getAvailableLibraries();
                        var lib = allLibraries.find(function (element) {
                            return (element.name === libraryName);
                        });
                        var libUID = undefined;
                        if (lib !== undefined) {
                            libUID = lib.uid;
                        }
                        return libUID;
                    }

                    showEditor (availableLibraries, currentLibraryName) {
                        var diag = this.shadowRoot.querySelector("#dselector");
                        var selector = this.shadowRoot.querySelector("#tselect");
                        selector.innerHTML = "";
                        $.each(availableLibraries, function(i, library) {
                            var option = document.createElement( 'option' );
                            option.uid = library.uid;
                            option.value = library.name;
                            option.text = library.name;
                            option.description = library.description;
                            selector.add(option);
                        });
                        selector.value = currentLibraryName;
                        this.editLibrary();
                        diag.showModal();
                    }

                    getLibrary(libraryName, successFn) {
                        var libraryUID = this.getLibraryUID(libraryName);
                        if (libraryUID !== undefined) {
                            if (libraryName.length > 0) {
                                $.ajax({
                                    type: "post",
                                    url: "/getlibraryvariablesvalues",
                                    data: {
                                        token: parent._currentToken,
                                        libraryUID: libraryUID 
                                    },
                                    success: successFn.bind(this),
                                    error: function (response) {
                                        console.log(response);
                                        alert(response);
                                    }
                                });
                            }
                        }
                    }

                    editLibrary (valueOnly = false) {
                        var editorComponents = this.iFrameEditor.contentDocument._frameComponents;
                        if (!valueOnly) {
                            var ownerReference = this.owner.getReference();
                            var ownerReferenceValue = this.owner.getReferenceValue();
                            var ownerInitialValue = this.owner.getInitialValue();
                            var ownerPlantValue = this.owner.getPlantValue();
                            if (ownerReference !== "none") {
                                if (ownerReferenceValue !== undefined) {
                                    this.getLibrary(ownerReferenceValue, function (response) {
                                        var variables = $.parseJSON(response);
                                        var keys = Object.keys(variables);
                                        for (var i in keys) { 
                                            var variableName = keys[i];
                                            var variableValue = variables[keys[i]];
                                            var comps = editorComponents[variableName];
                                            for (var c in comps) {
                                                comps[c].setReferenceValue(variableValue);
                                            }
                                        }
                                    });
                                }
                            }
                            if (ownerInitialValue !== undefined) {
                                this.getLibrary(ownerInitialValue, function (response) {
                                    var variables = $.parseJSON(response);
                                    var keys = Object.keys(variables);
                                    for (var i in keys) { 
                                        var variableName = keys[i];
                                        var variableValue = variables[keys[i]];
                                        var comps = editorComponents[variableName];
                                        for (var c in comps) {
                                            comps[c].setInitialValue(variableValue);
                                        }
                                    }
                                });
                            }
                            if (ownerPlantValue !== undefined) {
                                this.getLibrary(ownerPlantValue, function (response) {
                                    var variables = $.parseJSON(response);
                                    var keys = Object.keys(variables);
                                    for (var i in keys) { 
                                        var variableName = keys[i];
                                        var variableValue = variables[keys[i]];
                                        var comps = editorComponents[variableName];
                                        for (var c in comps) {
                                            comps[c].setPlantValue(variableValue);
                                        }
                                    }
                                });
                            }
                        } 
                        if (this.selector.selectedIndex >= 0) {
                            var option = this.selector.options[this.selector.selectedIndex];
                            var libraryName = option.text;
                            this.getLibrary(libraryName, function (response) {
                                var variables = $.parseJSON(response);
                                var keys = Object.keys(variables);
                                for (var i in keys) { 
                                    var variableName = keys[i];
                                    var variableValue = variables[keys[i]];
                                    var comps = editorComponents[variableName];
                                    for (var c in comps) {
                                        comps[c].setValue(variableValue);
                                    }
                                }
                                this.saveAsLibraryName.value = libraryName;
                                this.descriptionTextArea.value = option.description;
                            });
                        } 
                    }

                    createdCallback() {
                        // Get template 
                        var template = importDoc.querySelector("#tselector");

                        // import template into
                        var clone = document.importNode(template.content, true);
                        var root = this.createShadowRoot();
     
                        root.appendChild(clone);

                        var diag = this.shadowRoot.querySelector("#dselector");
                        this.selector = this.shadowRoot.querySelector("#tselect");
                        this.okButton = this.shadowRoot.querySelector("#tselectorOK");
                        var cancelButton = this.shadowRoot.querySelector("#tselectorCancel");
                        this.saveAsButton = this.shadowRoot.querySelector("#saveAsButton");
                        this.saveAsLibraryName = this.shadowRoot.querySelector("#saveAsLibraryName");
                        this.descriptionTextArea = this.shadowRoot.querySelector("#descriptionTextArea");

                        this.okButton.onclick = function() {
                            this.selected = this.selector.options[this.selector.selectedIndex].text;
                            this.owner.libraryChanged(this.selected);
                            diag.close();
                        }.bind(this); //bind is needed to make sure that the "this" is still valid in the context of the callback

                        cancelButton.onclick = function() {
                            this.selected = "";
                            diag.close();
                        }.bind(this); //bind is needed to make sure that the "this" is still valid in the context of the callback

                        this.selector.onchange = function() {
                            this.editLibrary(true);
                        }.bind(this);

                        this.iFrameEditor = this.shadowRoot.querySelector("#iframeeditor");
                        this.saveAsButton.onclick = function() {
                            var editorComponents = this.iFrameEditor.contentDocument._frameComponents;
                            var saveAsName = this.saveAsLibraryName.value;
                            var description = this.descriptionTextArea.value;
                            var user = JSON.parse(localStorage.user);
                            var variables = {};
                            for (var key in editorComponents) {
                                var comps = editorComponents[key];
                                //The same id might be used in different components...
                                for (var c in comps) {
                                    variables[comps[c].id] = comps[c].getValue();
                                }
                            }
                            if (saveAsName.length === 0) {
                                alert("Please introduce a library name");
                            }
                            else {
                                $.ajax({
                                    type: "post",
                                    url: "/savelibrary",
                                    data: {
                                        token: parent._currentToken,
                                        type: this.owner.getLibraryType(),
                                        name: saveAsName,
                                        description: description,
                                        username: user.username, 
                                        variables: JSON.stringify(variables)
                                    },
                                    success: function (response) {
                                        var library = $.parseJSON(response);
                                        if (library.uid !== undefined) {
                                            var optionsAsArray = Array.apply(null, this.selector.options).map(function(el){return el.text;});
                                            if(optionsAsArray.indexOf(saveAsName) == -1) {
                                                this.selector.options
                                                var option = document.createElement( 'option' );
                                                option.uid = library.uid;
                                                option.value = library.name;
                                                option.text = library.name;
                                                option.description = library.description;
                                                this.selector.add(option);
                                                this.selector.value = saveAsName;
                                                this.owner.addAvailableLibrary({id:library.id, name:saveAsName});
                                            }
                                            alert("Library updated successfully!");
                                        }
                                    }.bind(this),
                                    error: function (response) {
                                        console.log(response);
                                        alert(response);
                                    }
                                });
                            }
                        }.bind(this);
                        
                    }

                    setOwnerComponent(owner) {
                        this.owner = owner;
                        this.loadEditor(owner.getLibraryType());
                    }
                    
                    iFrameLoaded(libraryType) {
                        //Note that we want PMCComponents to the scope of each iframe
                        var editorComponents = this.iFrameEditor.contentDocument._frameComponents;
                        var allVariableIds = [];
                        for (var k in editorComponents) {
                            allVariableIds.push(k)
                        }
                        getLibraryVariablesInfo(libraryType, allVariableIds, 
                            function (response) {
                                var pvInfos = $.parseJSON(response);
                                var user = JSON.parse(localStorage.user);
                                for (var i in pvInfos) {
                                    var pvInfo = pvInfos[i];
                                    var targetElements = editorComponents[pvInfo.name];
                                    if (targetElements != null) {
                                        for (var j in targetElements) {
                                            populateComponentInfo(targetElements[j], pvInfo, user);                    
                                        }
                                    }
                                }
                            }.bind(this)
                        );

                        $.each(editorComponents, function (i, pmcCompArray) {
                            $.each(pmcCompArray, function (j, pmcComp) {
                                pmcComp.domLoaded();
                            });
                        });
                    }

                    loadEditor(libraryType) {
                        var editorUrl = "/pages/" + libraryType + ".html?" + new Date().getTime(); //new Date... to force reloading with no caching
                        this.iFrameEditor.onload = function(evt) {
                            this.iFrameLoaded(libraryType);
                        }.bind(this);
                        this.iFrameEditor.src = editorUrl;
                    }

                    getEditor() {
                        return this.editor;
                    }

                    setReadOnly (isReadOnly) {
                        this.okButton.disabled = isReadOnly;
                    }

                    setReference(referenceToSet) {
                        var editorComponents = this.iFrameEditor.contentDocument._frameComponents;
                        $.each(editorComponents, function (i, pmcCompArray) {
                            $.each(pmcCompArray, function (j, pmcComp) {
                                pmcComp.setReference(referenceToSet);
                            });
                        });
                    }

                    setUserAllowedToWrite (isUserAllowedToWrite) {
                        this.okButton.disabled = !isUserAllowedToWrite;
                    }
                }
                document.registerElement("pmc-library-editor", {
                    prototype: PMCLibraryEditor.prototype
                });
            })();
        </script>
    </body>
</html>
