<script>
    class Stream {
        constructor() {
            this.transformationListeners = [];
        }

        start () {
            this.stop();
            this.evtSrc = new EventSource("/stream?token=" + parent._currentToken);
            //Changed values are received in json format
            this.evtSrc.onmessage = function(e) {
                if (e.data.length > 0) {
                    var jsonData = $.parseJSON(e.data);
                    var reset = jsonData["reset"];
                    var transformationUID = jsonData["transformationUID"];
                    if (reset !== undefined) {
                        var tid = jsonData["tid"];
                        parent._remoteServerTid = tid;
                    }
                    else if (transformationUID !== undefined) {
                        this.fireTransformationUpdated(jsonData);
                    }
                    else {
                        var variables = jsonData["variables"];
                        var scheduleUID = jsonData["scheduleUID"];
                        var updateLive = (jsonData["live"] !== undefined);
                        var updateSchedule = (scheduleUID !== undefined);
                        var updateThisSchedule = (scheduleUID === parent._currentScheduleUID);
                        var updatePlant = ((!updateLive) && (scheduleUID === undefined));
                        //variables is a dictionary with name:value pairs
                        var mainFrameHtkComponents = parent._htkMainEditor.getAllHtkComponents();
                        //If it is to update a schedule and this is not the correct uid, do not even try
                        if ((updateLive) || (updateSchedule && updateThisSchedule) || (updatePlant)) {
                            for (var name in variables) {
                                //The same id might be used in different components
                                var targetElements = mainFrameHtkComponents[name];
                                var value = variables[name];
                                if (targetElements  !== undefined) {
                                    for (var i=0; i<targetElements.length; i++) {
                                        if ((updateSchedule) || (updateLive)) {
                                            targetElements[i].setValue(value, false);
                                            //Someone else changed but might not have commited!
                                            parent._scheduleValuesToCommit[name] = value;
                                        }
                                        else {
                                            targetElement.setPlantValue(value);
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }.bind(this);
        }

        stop () {
            if (this.evtSrc !== undefined) {
                this.evtSrc.close();
            }
        }

        fireTransformationUpdated(transformationInfo) {
            for (var i=0; i<this.transformationListeners.length; i++) {
                this.transformationListeners[i].transformationUpdated(transformationInfo);
            }
        }

        addTransformationListener(listener) {
            this.transformationListeners.push(listener);
        }
    }
</script>
