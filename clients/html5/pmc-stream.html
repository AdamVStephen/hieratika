<script>
    class Stream {
        constructor() {
            this.transformationListeners = [];
        }

        start () {
            this.stop();
            this.evtSrc = new EventSource("/stream?token=" + parent._currentToken);
            //Changed values are received in json format
            this.evtSrc.onmessage = function(e) {
                if (e.data.length > 0) {
                    var jsonData = $.parseJSON(e.data);
                    var reset = jsonData["reset"];
                    var transformationUID = jsonData["transformationUID"];
                    if (reset !== undefined) {
                        var tid = jsonData["tid"];
                        parent._remoteServerTid = tid;
                    }
                    else if (transformationUID !== undefined) {
                        this.fireTransformationUpdated(jsonData);
                    }
                    else {
                        var variables = jsonData["variables"];
                        var scheduleUID = jsonData["scheduleUID"];
                        var updateSchedule = false;
                        if (scheduleUID !== undefined) {
                            updateSchedule = true;
                        }
                        if ((!updateSchedule) || (scheduleUID === parent._currentScheduleUID)) {
                            //variables is a dictionary with name:value pairs
                            for (var name in variables) {
                                var targetElements = document._frameComponents[name];
                                var value = variables[name];
                                if (targetElements  !== undefined) {
                                    $.each(targetElements, function (i, targetElement) {
                                        if (updateSchedule) {
                                            targetElement.setValue(value, false);
                                            //Someone else changed but might not have commited!
                                            parent._scheduleValuesToCommit[name] = value;
                                        }
                                        else {
                                            targetElement.setPlantValue(value);
                                        }
                                    });
                                }
                            }
                        }
                    }
                }
            }.bind(this);
        }

        stop () {
            if (this.evtSrc !== undefined) {
                this.evtSrc.close();
            }
        }

        fireTransformationUpdated(transformationInfo) {
            for (var i=0; i<this.transformationListeners.length; i++) {
                this.transformationListeners[i].transformationUpdated(transformationInfo);
            }
        }

        addTransformationListener(listener) {
            this.transformationListeners.push(listener);
        }
    }
</script>
