<html>
    <head>
        <link rel="import" href="libraries.html">
        <link rel="import" href="htk-array-editor.html">
        <link rel="import" href="htk-component.html">
        <link rel="import" href="htk-enum.html">
        <link rel="import" href="htk-input.html">
        <link rel="import" href="htk-library-button.html">
    </head>
    <body>
        <template id="tstructbrowser">
            <style>
                .collapsibleList li{
                    list-style-image : url('/icons/tree-item-8.png');
                    cursor           : auto;
                }

                li.collapsibleListOpen{
                    list-style-image : url('/icons/tree-close-8.png');
                    cursor           : pointer;
                }
                
                li.collapsibleListClosed{
                    list-style-image : url('/icons/tree-open-8.png');
                    cursor           : pointer;
                }

                li.collapsibleListClosed:hover{
                    background-color: gray;
                }


            </style>
            <div id="dstructbrowser"></div>
        </template>

        <script>
            //This is enclosure is required to protect the importDoc
            (function () {
                var importDoc = document.currentScript.ownerDocument; // importee
                //Constructor
                class HtkStructBrowser extends HtkComponent {
                    constructor() {
                        super();
                    }

                    createdCallback () {
                        super.createdCallback();
                        this.mainDiv = this.shadowRoot.querySelector("#dstructbrowser");
                        this.treeHTML = "";
                    }
                    
                    getTemplate() {
                        var template = importDoc.querySelector("#tstructbrowser");
                        return template;
                    }

                    addMember(member, fullMemberName, callerMemberName = undefined) {
                        if (member !== undefined) {
                            var memberName = member["name"];
                            if (memberName !== undefined) {
                                var memberIsStruct = member["isStruct"]
                                if (memberIsStruct !== undefined) {
                                    memberIsStruct = (memberIsStruct === true);
                                }
                                if (memberIsStruct) {
                                    this.treeHTML += "<ul>\n";
                                    this.treeHTML += "<li>\n";
                                    if (callerMemberName !== undefined) {
                                        this.treeHTML += callerMemberName;
                                    }
                                    else {
                                        this.treeHTML += memberName;
                                    }
                                    this.treeHTML += "<ul>\n";
                                    var memberVariables = Object.keys(member);
                                    var fullMemberNameBeforeFor = fullMemberName;
                                    for (var i in memberVariables) {
                                        var subMemberName = memberVariables[i];
                                        //Check if it is a variable (which will have to have the isStruct field defined)
                                        var isVariable = (member[subMemberName] !== undefined);
                                        if (isVariable) {
                                            isVariable = (member[subMemberName]["isStruct"] !== undefined);
                                        }
                                        if (isVariable) {
                                            fullMemberName = fullMemberNameBeforeFor + "@" + subMemberName;
                                            this.addMember(member[subMemberName], fullMemberName, subMemberName);
                                        }
                                    } 
                                    this.treeHTML += "</ul>\n";
                                    this.treeHTML += "</li>\n";
                                    this.treeHTML += "</ul>\n";
                                }
                                else {
                                    this.treeHTML += "<ul>\n";
                                    this.treeHTML += "<li><div>\n";
                                    var memberNameValidCSS = "P" + memberName.replace(/[|&;$%@"<>()+,]/g, "");
                                    memberNameValidCSS = memberNameValidCSS.replace(/:/g, "");
                                    if (member.numberOfElements > 1) {
                                        this.treeHTML += callerMemberName + ": <htk-array-editor id=\"" + fullMemberName + "\" name=\"" + fullMemberName + "\" class=\"" + memberNameValidCSS + "\"></htk-array-editor>\n";
                                    }
                                    else {
                                        if (member.type === "enum") {
                                            this.treeHTML += callerMemberName + ": <htk-enum id=\"" + fullMemberName + "\" name=\"" + fullMemberName + "\" class=\"" + memberNameValidCSS + "\"></htk-enum>\n";
                                        }
                                        else if (member.type === "library") {
                                            this.treeHTML += callerMemberName + ": <htk-library-button id=\"" + fullMemberName + "\" name=\"" + fullMemberName + "\" class=\"" + memberNameValidCSS + "\"></htk-library-button>\n";
                                        }
                                        else {
                                            this.treeHTML += callerMemberName + ": <htk-input id=\"" + fullMemberName + "\" name=\"" + fullMemberName + "\" class=\"" + memberNameValidCSS + "\"></htk-input>\n";
                                        }
                                    }
                                    this.treeHTML += "</div></li>\n";
                                    this.treeHTML += "</ul>\n";
                                }
                            }
                        }
                    }
        
                    populateComponentInfo(member, user) {
                        if (member !== undefined) {
                            var memberName = member["name"];
                            if (memberName !== undefined) {
                                var memberIsStruct = member["isStruct"]
                                if (memberIsStruct !== undefined) {
                                    memberIsStruct = (memberIsStruct === true);
                                }
                                if (memberIsStruct) {
                                    var membersNames = Object.keys(member);
                                    for (var i in membersNames) {
                                        var subMemberName = membersNames[i];
                                        var isVariable = (member[subMemberName] !== undefined);
                                        if (isVariable) {
                                            isVariable = (member[subMemberName]["isStruct"] !== undefined);
                                        }
                                        if (isVariable) {
                                            this.populateComponentInfo(member[subMemberName], user);
                                        }
                                    } 
                                }
                                else {
                                    var memberNameValidCSS = ".P" + memberName.replace(/[|&;$%@"<>()+,]/g, "");
                                    memberNameValidCSS = memberNameValidCSS.replace(/:/g, "");
                                    var compMember = this.shadowRoot.querySelector(memberNameValidCSS);
                                    compMember.setVariable(member);
                                    compMember.checkUserAllowedToWrite(user);
                                }
                            }
                        }
                    }

                    setVariable (variable) {
                        super.setVariable(variable);
                        this.name = this.id;
                        this.isStruct = this.isStruct();
                        this.mainDiv.innerHTML = "Loading structure, please wait";
                        this.treeHTML = "<ul class=\"collapsibleList\" id=\"struct-tree\">";
                        this.addMember(this, this.name);
                        this.treeHTML += "</ul>";
                        this.mainDiv.innerHTML = this.treeHTML;
                        var user = JSON.parse(localStorage.user);
                        this.populateComponentInfo(this, user);
                        var tree = this.shadowRoot.querySelector("#struct-tree");
                        CollapsibleLists.applyTo(tree);
                    }
                }
                document.registerElement("htk-struct-browser", {
                    prototype: HtkStructBrowser.prototype,
                });
            })(); 
        </script>
    </body>
</html>
