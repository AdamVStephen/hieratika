<!DOCTYPE html>
<html>
<head>
    <link rel="import" href="libraries.html">
    <link rel="import" href="pmc-helper.html">
    <link rel="import" href="pmc-login.html">
    <link rel="import" href="pmc-main-editor.html">
    <link rel="import" href="pmc-page-selector.html">
    <link rel="import" href="pmc-schedule-selector.html">
    <link rel="import" href="pmc-stream.html">
</head>
<body>
    <script>
    </script>
    <template id="ttopnav">
        <style>
            @import url("/css/w3.css");
            @import url("/css/font-awesome-4.7.0/css/font-awesome.min.css");
        </style>
        <div class="w3-sidebar w3-bar-block w3-dark-grey w3-animate-left w3-large" style="display:none" id="tsidebar">
            <button class="w3-bar-item w3-button w3-tiny w3-light-grey" id="tsidebarclose"><i class="fa fa-arrow-left"></i></button>
            <button class="w3-bar-item w3-button w3-border-bottom" id="loginbtn"><i class="fa fa-user-o"> Login</i></button>
            <button href="#" class="w3-bar-item w3-button w3-border-bottom" title="Set the current page" id="pageselectbtn"><i class="fa fa-external-link"> Open</i></button>
            <button class="w3-button w3-block w3-left-align" id="tviewaccbtn"><i class="fa fa-info"></i> View <i class="fa fa-caret-down"></i></button>
            <div id="tviewacc" class="w3-hide w3-green w3-card">
                <button class="w3-bar-item w3-button w3-text-white" title="View the plant" id="viewplantbtn"><i class="fa fa-thermometer-full"></i> Plant</button>
                <button class="w3-bar-item w3-button w3-text-white" title="Edit a schedule" id="viewschedulebtn"><i class="fa fa-code-fork"></i> Schedule</button>
            </div>
            <button class="w3-bar-item w3-button w3-border-bottom" id="editschedulebtn"><i class="fa fa-code-fork"></i> Edit</button>
            <button class="w3-button w3-block w3-left-align" id="trefaccbtn"><i class="fa fa-ellipsis-v"></i> Compare <i class="fa fa-caret-down"></i></button>
            <div id="trefacc" class="w3-hide w3-green w3-card">
                <button class="w3-bar-item w3-button w3-text-white" title="Remove the reference" id="refselectnonebtn"><i class="fa fa-times" style="color:#cc0000;"></i> Remove</button>
                <button class="w3-bar-item w3-button w3-text-white" title="Set the plant as the reference" id="refselectplantbtn"><i class="fa fa-thermometer-full"></i> Plant</button>
                <button class="w3-bar-item w3-button w3-text-white" title="Set another schedule as the reference" id="refselectschedulebtn"><i class="fa fa-code-fork"></i> Schedule</button>
            </div>
            <button class="w3-button w3-block w3-left-align" id="tcpyaccbtn"><i class="fa fa-files-o"></i> Copy <i class="fa fa-caret-down"></i></button>
            <div id="tcpyacc" class="w3-hide w3-green w3-card">
                <button class="w3-bar-item w3-button w3-text-white" title="Copy from the plant" id="cpyreferenceplantbtn"><i class="fa fa-thermometer-full"></i> Plant</button>
                <button class="w3-bar-item w3-button w3-text-white" title="Copy from a given schedule" id="cpyreferenceschedulebtn"><i class="fa fa-code-fork"></i> Schedule</button>
            </div>
            <button class="w3-bar-item w3-button w3-border-top" title="Commit all changes to current schedule" id="commitbtn"><i class="fa fa-floppy-o"></i> Commit</button>
            <button class="w3-bar-item w3-button" title="Undo all changes" id="undobtn"><i class="fa fa-undo"></i> Undo</button>
            <button class="w3-bar-item w3-button w3-border-top" title="Load current values into plant" id="loadplantbtn"><i class="fa fa-upload"></i> Load</button>
        </div>
        <div class="w3-bar w3-dark-grey w3-tiny">
            <button class="w3-button" id="tsidebaropen">&#9776;</button>
            <span class="w3-bar-item w3-right" id="currentdisplay">None</span>
            <span class="w3-bar-item w3-right w3-border-left">Displaying: </span>
            <span class="w3-bar-item w3-right" id="currentreference">None</span>
            <span class="w3-bar-item w3-right w3-border-left">Reference: </span>
            <span class="w3-bar-item w3-right" id="username">(login first)</span>
            <span class="w3-bar-item w3-right w3-border-left">Username: </span>
        </div>
        <pmc-login id="pmclogin"></pmc-login>
        <pmc-page-selector id="pageselector"></pmc-page-selector>
        <pmc-schedule-selector id="scheduleselector"></pmc-schedule-selector>
    </template>

    <script>
        //This is enclosure is required to protect the importDoc
        (function () {
            var importDoc = document.currentScript.ownerDocument; // importee
            class PMCTopNav extends HTMLElement {
                constructor() {
                    super();
                }


                createdCallback () {
                    var template = importDoc.querySelector("#ttopnav");
                    // import template into
                    var clone = document.importNode(template.content, true);
                    var root = this.createShadowRoot();
                    root.appendChild(clone);

                    this.sideBar = this.shadowRoot.querySelector("#tsidebar");
                    var sideBarOpen = this.shadowRoot.querySelector("#tsidebaropen");
                    var sideBarClose = this.shadowRoot.querySelector("#tsidebarclose");
                    sideBarOpen.onclick = function(evt) {
                        this.sideBar.style.display = "block";
                    }.bind(this); 

                    sideBarClose.onclick = function() {
                        this.hideSideBar();
                    }.bind(this); 

                    var viewAccordion = this.shadowRoot.querySelector("#tviewacc");
                    var viewAccordionButton = this.shadowRoot.querySelector("#tviewaccbtn");
                    viewAccordionButton.onclick = function() {
                        this.handleAccordionClick(viewAccordion);
                    }.bind(this);

                    var refAccordion = this.shadowRoot.querySelector("#trefacc");
                    var refAccordionButton = this.shadowRoot.querySelector("#trefaccbtn");
                    refAccordionButton.onclick = function() {
                        this.handleAccordionClick(refAccordion);
                    }.bind(this);

                    var copyAccordion = this.shadowRoot.querySelector("#tcpyacc");
                    var copyAccordionButton = this.shadowRoot.querySelector("#tcpyaccbtn");
                    copyAccordionButton.onclick = function() {
                        this.handleAccordionClick(copyAccordion);
                    }.bind(this);

                    this.loadPlantButton = this.shadowRoot.querySelector("#loadplantbtn");
                    this.loadPlantButton.onclick = function() {
                        loadIntoPlant(this.selectedPage.name);
                        this.hideSideBar();
                    }.bind(this); 

                    this.pageSelectButton = this.shadowRoot.querySelector("#pageselectbtn");
                    this.loginButton = this.shadowRoot.querySelector("#loginbtn");
                    this.loginDialog = this.shadowRoot.querySelector("#pmclogin");
                    this.loginDialog.addLoginListener(this);
                    this.loginButton.onclick = function() {
                        this.hideSideBar();
                        if (localStorage.user === undefined) {
                            this.loginDialog.show();
                        }
                        else {
                            this.fireUserLogout();
                        }
                    }.bind(this);

                    this.standalone = this.getAttribute("data-standalone");
                    if (this.standalone !== undefined) {
                        this.standalone = (this.standalone.toLowerCase() === "true");
                    }
                    else {
                        this.standalone = false;
                    }
                    if (!this.standalone) {
                        this.streamer = new Stream();
                    }
                    this.loginButton.disabled = this.standalone;

                    this.pageSelector = this.shadowRoot.querySelector("#pageSelector");
                    this.pageSelectButton.onclick = function() {
                        this.hideSideBar();
                        parent._currentScheduleUID = undefined;
                        this.pageSelector.show(this.firePageChanged.bind(this));
                    }.bind(this);
                   
                    this.scheduleSelector = this.shadowRoot.querySelector("#scheduleselector");
                    this.editScheduleButton = this.shadowRoot.querySelector("#editschedulebtn");
                    this.editScheduleButton.onclick = function() {
                        this.hideSideBar();
                        this.scheduleSelector.show(this.editScheduleChanged.bind(this), this.user.id);
                    }.bind(this);

                    this.viewScheduleButton = this.shadowRoot.querySelector("#viewschedulebtn");
                    this.viewScheduleButton.onclick = function() {
                        this.hideSideBar();
                        this.handleAccordionClick(viewAccordion);
                        this.scheduleSelector.show(this.viewScheduleChanged.bind(this));
                    }.bind(this);

                    this.viewPlantButton = this.shadowRoot.querySelector("#viewplantbtn");
                    this.viewPlantButton.onclick = function() {
                        this.hideSideBar();
                        this.handleAccordionClick(viewAccordion);
                        parent._currentScheduleUID = undefined;
                        this.currentDisplay.innerHTML = PLANT_NAME;
                        this.loadPlantButton.disabled = true;
                        this.copyFromReferenceScheduleButton.disabled = true;
                        this.copyFromReferencePlantButton.disabled = true;
                        this.commitButton.disabled = true;
                        this.undoButton.disabled = true;
                        displayPlant();
                    }.bind(this);

                    this.usernameDisplay = this.shadowRoot.querySelector("#username");
                    this.currentDisplay = this.shadowRoot.querySelector("#currentdisplay");
                    this.currentReference = this.shadowRoot.querySelector("#currentreference");

                    if (localStorage.user === undefined) {
                        this.loginButton.value = "<i class='fa fa-user-o'> Login</i>";
                    }
                    else {
                        var user = JSON.parse(localStorage.user);
                        parent._currentToken = localStorage.currentToken;
                        this.loginSuccessful(user);
                    }
                    this.pageSelect = this.shadowRoot.querySelector("#pageselect");

                    this.referenceSelectNoneButton = this.shadowRoot.querySelector("#refselectnonebtn");
                    this.referenceSelectNoneButton.onclick = function () {
                        this.hideSideBar();
                        this.handleAccordionClick(refAccordion);
                        setReference(NONE_NAME);
                        this.currentReference.innerHTML = NONE_NAME; 
                        this.currentReference.style.color = NONE_COLOR;
                    }.bind(this);

                    this.referenceSelectPlantButton = this.shadowRoot.querySelector("#refselectplantbtn");
                    this.referenceSelectPlantButton.onclick = function () {
                        this.hideSideBar();
                        this.handleAccordionClick(refAccordion);
                        setReference(PLANT_NAME);
                        this.currentReference.innerHTML = PLANT_NAME; 
                    }.bind(this);

                    this.referenceSelectScheduleButton = this.shadowRoot.querySelector("#refselectschedulebtn");
                    this.referenceSelectScheduleButton.onclick = function () {
                        this.hideSideBar();
                        this.handleAccordionClick(refAccordion);
                        this.scheduleSelector.show(this.refererenceScheduleChanged.bind(this));
                    }.bind(this); 

                    this.copyFromReferenceScheduleButton = this.shadowRoot.querySelector("#cpyreferenceschedulebtn");
                    this.copyFromReferenceScheduleButton.onclick = function () {
                        this.hideSideBar();
                        this.handleAccordionClick(copyAccordion);
                        this.scheduleSelector.show(this.copyFromScheduleChanged.bind(this));
                    }.bind(this);

                    this.copyFromReferencePlantButton = this.shadowRoot.querySelector("#cpyreferenceplantbtn");
                    this.copyFromReferencePlantButton.onclick = function () {
                        this.hideSideBar();
                        this.handleAccordionClick(copyAccordion);
                        var mainFramePMCComponents = parent._pmcMainEditor.getAllPMCComponents();
                        $.each(mainFramePMCComponents, function (i, pmcCompArray) {
                            $.each(pmcCompArray, function (j, pmcComp) {
                                pmcComp.setValue(pmcComp.getPlantValue());
                            });
                        });
                    }.bind(this);


                    this.commitButton = this.shadowRoot.querySelector("#commitbtn");
                    this.commitButton.onclick = function () {
                        this.hideSideBar();
                        commitAllChangesToSchedule();
                    }.bind(this);

                    this.undoButton = this.shadowRoot.querySelector("#undobtn");
                    this.undoButton.onclick = function () {
                        this.hideSideBar();
                        undoAllChangesToSchedule();
                    }.bind(this);

                    this.pageListeners = [this];
                    this.userLogoutListeners = [this];
                    this.addPageListener(this.scheduleSelector);
                    this.disableAllButPageSelect();
                }
    
                attachedCallback() {
                    if (this.standalone) {
                        this.loginDialog.loginToServer("", "");
                    }
                }

                handleAccordionClick(acc) {
                    if (acc.className.indexOf("w3-show") == -1) {
                        acc.className += " w3-show";
                    } else { 
                        acc.className = acc.className.replace(" w3-show", "");
                    }
                }

                hideSideBar() {
                    this.sideBar.style.display = "none";
                }

                plantInfoLoaded() {
                    this.referenceSelectScheduleButton.disabled = false;
                    this.referenceSelectNoneButton.disabled = false;
                    this.referenceSelectPlantButton.disabled = false;
                    this.currentDisplay.innerHTML = PLANT_NAME;
                }

                loginSuccessful(user) {
                    this.user = user;
                    if (!this.standalone) {
                        this.streamer.start();
                    }
                    this.usernameDisplay.innerHTML = this.user.username; 
                    this.usernameDisplay.title = "username: " + this.user.username;

                    this.loginButton.innerHTML = "<i class='fa fa-user-o'> Logout</i>";

                    this.pageSelectButton.disabled = false;
                }
                
                firePageChanged(page) {
                    for(var l in this.pageListeners) {
                        this.pageListeners[l].pageChanged(page);
                    }
                }

                fireUserLogout() {
                    for(var l in this.userLogoutListeners) {
                        this.userLogoutListeners[l].userLogout();
                    }
                }

                userLogout() {
                    $.ajax({
                        type: "post",
                        url: "/logout",
                        data: "token=" + parent._currentToken
                    });
                    localStorage.removeItem("user");
                    localStorage.removeItem("schedule");
                    this.usernameDisplay.innerHTML = "...";
                    this.currentDisplay.innerHTML = NONE_NAME; 
                    this.currentDisplay.style.color = NONE_COLOR; 
                    this.currentReference.innerHTML = NONE_NAME; 
                    this.currentReference.style.color = NONE_COLOR; 
                    this.loginButton.innerHTML = "<i class='fa fa-user-o'> Login</i>";
                    this.pageSelectButton.disabled = true;
                    this.disableAllButPageSelect();
                    if (!this.standalone) {
                        this.streamer.stop();
                    }
                }

                disableAllButPageSelect() {
                    this.loadPlantButton.disabled = true;
                    this.editScheduleButton.disabled = true;
                    this.viewPlantButton.disabled = true;
                    this.viewScheduleButton.disabled = true;
                    this.copyFromReferenceScheduleButton.disabled = true;
                    this.copyFromReferencePlantButton.disabled = true;
                    this.referenceSelectScheduleButton.disabled = true;
                    this.referenceSelectNoneButton.disabled = true;
                    this.referenceSelectPlantButton.disabled = true;
                    this.commitButton.disabled = true;
                    this.undoButton.disabled = true;
                }

                pageChanged(page) {
                    this.selectedPage = page;
                    this.editScheduleButton.disabled = false;
                    this.viewScheduleButton.disabled = false;
                    this.viewPlantButton.disabled = false;
                    this.referenceSelectScheduleButton.disabled = false;
                    this.referenceSelectNoneButton.disabled = false;
                    this.referenceSelectPlantButton.disabled = false;
                }

                refererenceScheduleChanged(schedule) {
                    this.currentReference.innerHTML = schedule.name; 
                    setReference(schedule.uid);
                }

                copyFromScheduleChanged(schedule) {
                    copyFromSchedule(schedule.uid, false, true, false);
                }

                editScheduleChanged(schedule) {
                    this.currentDisplay.innerHTML = schedule.name; 
                    copyFromSchedule(schedule.uid, true, false, false);
                    parent._currentScheduleUID = schedule.uid;
                    this.loadPlantButton.disabled = false;
                    this.copyFromReferenceScheduleButton.disabled = false;
                    this.copyFromReferencePlantButton.disabled = false;
                    this.commitButton.disabled = false;
                    this.undoButton.disabled = false;
                }

                viewScheduleChanged(schedule) {
                    this.currentDisplay.innerHTML = schedule.name; 
                    copyFromSchedule(schedule.uid, true, false, true);
                    parent._currentScheduleUID = schedule.uid;
                    this.loadPlantButton.disabled = false;
                    this.copyFromReferenceScheduleButton.disabled = true;
                    this.copyFromReferencePlantButton.disabled = true;
                    this.commitButton.disabled = true;
                    this.undoButton.disabled = true;
                }
            
                addPageListener(listener) {
                    this.pageListeners.push(listener);
                }
    
                addUserLogoutListener(listener) {
                    this.userLogoutListeners.push(listener);
                }

            }

            document.registerElement("pmc-top-nav", {
                prototype: PMCTopNav.prototype,
            });

        }());
    </script>
</body>
</html>
